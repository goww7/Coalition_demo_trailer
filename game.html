<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coalitions MVP - Interactive Globe</title>
    
    <!-- Cesium -->
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.120/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.120/Build/Cesium/Cesium.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body, html {
            height: 100%;
            font-family: 'SF Pro Text', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #000;
            color: white;
            overflow: hidden;
        }

        #cesiumContainer {
            width: 100%;
            height: 100%;
            background: #000;
        }

        /* Enhanced Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(135deg, rgba(0, 0, 0, 0.95) 0%, rgba(15, 25, 45, 0.9) 50%, rgba(0, 102, 255, 0.8) 100%),
                url('https://images-assets.nasa.gov/image/PIA18033/PIA18033~large.jpg') center/cover;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
            transform: scale(1.1);
        }

        .loading-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .loading-title {
            font-size: clamp(3rem, 8vw, 5rem);
            font-weight: 800;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #ffffff, #5AC8FA, #007AFF);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.02em;
        }

        .loading-subtitle {
            font-size: clamp(1.2rem, 3vw, 1.8rem);
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 0.5rem;
            font-weight: 300;
        }

        .loading-tagline {
            font-size: 1rem;
            color: rgba(90, 200, 250, 0.8);
            font-weight: 500;
        }

        .loading-progress-container {
            width: 400px;
            max-width: 80vw;
            margin: 3rem 0;
        }

        .loading-progress {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 1rem;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .loading-bar {
            height: 100%;
            background: linear-gradient(90deg, #5AC8FA, #007AFF, #5AC8FA);
            background-size: 200% 100%;
            border-radius: 3px;
            width: 0%;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            animation: shimmer 2s infinite;
            box-shadow: 0 0 20px rgba(90, 200, 250, 0.5);
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .loading-text {
            font-size: 1rem;
            color: #ccc;
            text-align: center;
            min-height: 1.5rem;
        }

        .loading-features {
            margin-top: 2rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            max-width: 800px;
            opacity: 0.8;
        }

        .loading-feature {
            text-align: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(90, 200, 250, 0.2);
        }

        .loading-feature-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .loading-feature-text {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .return-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background: linear-gradient(135deg, rgba(90, 200, 250, 0.9) 0%, rgba(0, 122, 255, 1) 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 24px;
            font-weight: 600;
            text-decoration: none;
            z-index: 1000;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(90, 200, 250, 0.3);
            font-family: inherit;
        }

        .return-button:hover {
            background: linear-gradient(135deg, rgba(90, 200, 250, 1) 0%, rgba(0, 122, 255, 1) 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(90, 200, 250, 0.4);
        }

        .satellite-button {
            position: fixed;
            top: 20px;
            left: 250px;
            background: linear-gradient(135deg, rgba(255, 68, 68, 0.9) 0%, rgba(200, 0, 0, 1) 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 24px;
            font-weight: 600;
            text-decoration: none;
            z-index: 1000;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 68, 68, 0.3);
            font-family: inherit;
            cursor: pointer;
        }

        .satellite-button:hover {
            background: linear-gradient(135deg, rgba(255, 68, 68, 1) 0%, rgba(200, 0, 0, 1) 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(255, 68, 68, 0.4);
        }

        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(90, 200, 250, 0.4);
            border-radius: 12px;
            padding: 15px 20px;
            max-width: 350px;
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification-title {
            font-weight: 600;
            color: #5AC8FA;
            margin-bottom: 5px;
        }

        .notification-text {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
        }

        /* LAYER SYSTEM STYLES */
        .layer-selector-ring {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 600px;
            height: 600px;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 1500;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .layer-selector-ring.active {
            opacity: 1;
            pointer-events: auto;
        }

        .layer-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 2px solid rgba(90, 200, 250, 0.3);
            border-radius: 50%;
            animation: rotate 60s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .layer-button {
            position: absolute;
            width: 80px;
            height: 80px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #5AC8FA;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'SF Pro Text', sans-serif;
            color: white;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            animation: counterRotate 60s linear infinite;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        @keyframes counterRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(-360deg); }
        }

        .layer-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(90, 200, 250, 0.4);
            border-color: #ffffff;
        }

        .layer-button.active {
            background: rgba(90, 200, 250, 0.9);
            border-color: #ffffff;
            transform: scale(1.2);
            box-shadow: 0 8px 40px rgba(90, 200, 250, 0.6);
        }

        .layer-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .layer-name {
            font-size: 9px;
            line-height: 1;
        }

        /* Layer-specific button positioning */
        .layer-button:nth-child(1) { top: 0; left: 50%; transform: translateX(-50%); } /* Military */
        .layer-button:nth-child(2) { top: 15%; right: 15%; } /* Economy */
        .layer-button:nth-child(3) { top: 50%; right: 0; transform: translateY(-50%); } /* Diplomacy */
        .layer-button:nth-child(4) { bottom: 15%; right: 15%; } /* Intelligence */
        .layer-button:nth-child(5) { bottom: 0; left: 50%; transform: translateX(-50%); } /* Infrastructure */
        .layer-button:nth-child(6) { bottom: 15%; left: 15%; } /* Opinion */
        .layer-button:nth-child(7) { top: 50%; left: 0; transform: translateY(-50%); } /* Research */
        .layer-button:nth-child(8) { top: 15%; left: 15%; } /* Environment */

        /* Layer Control Panel */
        .layer-control-panel {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #5AC8FA;
            border-radius: 12px;
            padding: 15px 25px;
            z-index: 1600;
            backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
        }

        .current-layer-info {
            color: #5AC8FA;
            font-weight: 600;
            font-size: 14px;
        }

        .layer-toggle-btn {
            background: rgba(90, 200, 250, 0.2);
            border: 1px solid #5AC8FA;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
            font-weight: 600;
        }

        .layer-toggle-btn:hover {
            background: rgba(90, 200, 250, 0.4);
            transform: translateY(-2px);
        }

        /* Globe Overlays for Each Layer */
        .globe-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s ease;
            z-index: 100;
        }

        .globe-overlay.active {
            opacity: 1;
        }

        /* Layer Themes */
        .layer-military .layer-control-panel { border-color: #ff4444; background: rgba(255, 68, 68, 0.1); }
        .layer-military .current-layer-info { color: #ff4444; }
        
        .layer-economy .layer-control-panel { border-color: #ffdd44; background: rgba(255, 221, 68, 0.1); }
        .layer-economy .current-layer-info { color: #ffdd44; }
        
        .layer-diplomacy .layer-control-panel { border-color: #44ddff; background: rgba(68, 221, 255, 0.1); }
        .layer-diplomacy .current-layer-info { color: #44ddff; }
        
        .layer-intelligence .layer-control-panel { border-color: #bb44ff; background: rgba(187, 68, 255, 0.1); }
        .layer-intelligence .current-layer-info { color: #bb44ff; }
        
        .layer-infrastructure .layer-control-panel { border-color: #ff8844; background: rgba(255, 136, 68, 0.1); }
        .layer-infrastructure .current-layer-info { color: #ff8844; }
        
        .layer-opinion .layer-control-panel { border-color: #44ff88; background: rgba(68, 255, 136, 0.1); }
        .layer-opinion .current-layer-info { color: #44ff88; }
        
        .layer-research .layer-control-panel { border-color: #88ff44; background: rgba(136, 255, 68, 0.1); }
        .layer-research .current-layer-info { color: #88ff44; }
        
        .layer-environment .layer-control-panel { border-color: #44ff44; background: rgba(68, 255, 68, 0.1); }
        .layer-environment .current-layer-info { color: #44ff44; }

        /* Layer Data Panels */
        .layer-data-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            max-height: 400px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #5AC8FA;
            border-radius: 12px;
            padding: 20px;
            z-index: 1500;
            backdrop-filter: blur(20px);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            overflow-y: auto;
        }

        .layer-data-panel.active {
            opacity: 1;
            transform: translateY(0);
        }

        .layer-data-title {
            font-size: 16px;
            font-weight: 600;
            color: #5AC8FA;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .layer-stat {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .layer-stat-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
        }

        .layer-stat-value {
            color: white;
            font-weight: 600;
            font-size: 12px;
        }

        /* COMMAND CENTER MULTI-SCREEN SYSTEM */
        .command-screens {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 340px; /* Leave space for layer data panel */
            height: 200px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 10px;
            z-index: 1400;
            opacity: 0;
            transform: translateY(30px);
            transition: all 0.5s ease;
        }

        .command-screens.active {
            opacity: 1;
            transform: translateY(0);
        }

        .command-screen {
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid rgba(90, 200, 250, 0.3);
            border-radius: 8px;
            padding: 12px;
            backdrop-filter: blur(20px);
            font-family: 'SF Pro Text', sans-serif;
            font-size: 11px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .command-screen:hover {
            border-color: rgba(90, 200, 250, 0.6);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .screen-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            color: #5AC8FA;
            font-weight: 600;
            font-size: 10px;
        }

        .screen-title {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .screen-status {
            font-size: 8px;
            padding: 2px 6px;
            background: rgba(90, 200, 250, 0.2);
            border-radius: 10px;
        }

        .screen-content {
            color: white;
            font-size: 10px;
            line-height: 1.4;
        }

        .budget-item {
            display: flex;
            justify-content: space-between;
            margin: 3px 0;
            padding: 2px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .budget-label {
            color: rgba(255, 255, 255, 0.7);
        }

        .budget-value {
            font-weight: 600;
        }

        .budget-positive { color: #4CAF50; }
        .budget-negative { color: #F44336; }
        .budget-neutral { color: #FFC107; }

        .event-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 4px 0;
            padding: 4px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            border-left: 3px solid #5AC8FA;
        }

        .event-urgent { border-left-color: #F44336; }
        .event-warning { border-left-color: #FFC107; }
        .event-success { border-left-color: #4CAF50; }

        .event-time {
            font-size: 8px;
            color: rgba(255, 255, 255, 0.5);
            min-width: 35px;
        }

        .event-text {
            font-size: 9px;
            flex: 1;
        }

        .objective-item {
            margin: 4px 0;
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            border-left: 3px solid #4CAF50;
        }

        .objective-pending { border-left-color: #FFC107; }
        .objective-failed { border-left-color: #F44336; }

        .objective-title {
            font-weight: 600;
            font-size: 9px;
            margin-bottom: 2px;
        }

        .objective-progress {
            font-size: 8px;
            color: rgba(255, 255, 255, 0.7);
        }

        .intel-feed-item {
            margin: 3px 0;
            padding: 3px 6px;
            background: rgba(187, 68, 255, 0.1);
            border-radius: 4px;
            border-left: 2px solid #bb44ff;
        }

        .intel-source {
            font-size: 8px;
            color: #bb44ff;
            font-weight: 600;
        }

        .intel-content {
            font-size: 9px;
            margin-top: 2px;
        }

        .crisis-item {
            margin: 4px 0;
            padding: 6px;
            background: rgba(255, 68, 68, 0.1);
            border-radius: 4px;
            border: 1px solid rgba(255, 68, 68, 0.3);
        }

        .crisis-level {
            font-size: 8px;
            font-weight: 600;
            color: #ff4444;
            margin-bottom: 3px;
        }

        .crisis-description {
            font-size: 9px;
        }

        .crisis-actions {
            margin-top: 4px;
            display: flex;
            gap: 4px;
        }

        .crisis-action {
            font-size: 7px;
            padding: 2px 6px;
            background: rgba(255, 68, 68, 0.2);
            border: 1px solid rgba(255, 68, 68, 0.4);
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .crisis-action:hover {
            background: rgba(255, 68, 68, 0.4);
        }

        /* Screen Toggle Controls */
        .screen-toggle {
            position: fixed;
            bottom: 230px;
            left: 20px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #5AC8FA;
            border-radius: 8px;
            padding: 8px 12px;
            color: #5AC8FA;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            z-index: 1500;
        }

        .screen-toggle:hover {
            background: rgba(90, 200, 250, 0.2);
            transform: translateY(-2px);
        }

        /* CINEMATIC EVENT SYSTEM */
        .event-cascade-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            z-index: 3000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .event-cascade-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .cascade-container {
            max-width: 80vw;
            max-height: 80vh;
            text-align: center;
            color: white;
        }

        .cascade-title {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #ff4444, #ff8844, #ffdd44);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.05); filter: brightness(1.3); }
        }

        .cascade-description {
            font-size: 1.2rem;
            margin-bottom: 2rem;
            color: rgba(255, 255, 255, 0.9);
        }

        .cascade-effects {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .cascade-effect {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 1rem;
            animation: slide-in 0.5s ease forwards;
            opacity: 0;
            transform: translateY(30px);
        }

        .cascade-effect:nth-child(1) { animation-delay: 0.2s; }
        .cascade-effect:nth-child(2) { animation-delay: 0.4s; }
        .cascade-effect:nth-child(3) { animation-delay: 0.6s; }
        .cascade-effect:nth-child(4) { animation-delay: 0.8s; }

        @keyframes slide-in {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .effect-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .effect-layer {
            font-size: 0.9rem;
            font-weight: 600;
            color: #5AC8FA;
        }

        .effect-description {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 0.5rem;
        }

        .cascade-progress {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            margin: 2rem 0;
            overflow: hidden;
        }

        .cascade-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #5AC8FA, #007AFF);
            width: 0%;
            transition: width 0.3s ease;
            animation: progress-pulse 2s infinite;
        }

        @keyframes progress-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Enhanced Notifications */
        .enhanced-notification {
            position: fixed;
            top: 100px;
            right: 20px;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            border: 2px solid #5AC8FA;
            border-radius: 12px;
            padding: 20px;
            max-width: 400px;
            z-index: 2001;
            transform: translateX(450px);
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .enhanced-notification.show {
            transform: translateX(0);
        }

        .enhanced-notification.urgent {
            border-color: #ff4444;
            animation: urgent-pulse 1s infinite;
        }

        @keyframes urgent-pulse {
            0%, 100% { box-shadow: 0 10px 40px rgba(255, 68, 68, 0.3); }
            50% { box-shadow: 0 10px 60px rgba(255, 68, 68, 0.7); }
        }

        .enhanced-notification-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .enhanced-notification-icon {
            font-size: 1.5rem;
        }

        .enhanced-notification-title {
            font-weight: 600;
            color: #5AC8FA;
            font-size: 14px;
        }

        .enhanced-notification-time {
            margin-left: auto;
            font-size: 10px;
            color: rgba(255, 255, 255, 0.5);
        }

        .enhanced-notification-body {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.4;
            margin-bottom: 15px;
        }

        .enhanced-notification-effects {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .notification-effect-tag {
            font-size: 9px;
            padding: 3px 8px;
            background: rgba(90, 200, 250, 0.2);
            border: 1px solid rgba(90, 200, 250, 0.4);
            border-radius: 12px;
            color: #5AC8FA;
        }

        .notification-effect-tag.military { background: rgba(255, 68, 68, 0.2); border-color: rgba(255, 68, 68, 0.4); color: #ff4444; }
        .notification-effect-tag.economy { background: rgba(255, 221, 68, 0.2); border-color: rgba(255, 221, 68, 0.4); color: #ffdd44; }
        .notification-effect-tag.diplomacy { background: rgba(68, 221, 255, 0.2); border-color: rgba(68, 221, 255, 0.4); color: #44ddff; }

        /* INTERACTIVE DIPLOMACY SYSTEM */
        .diplomacy-interface {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.9);
            z-index: 4000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
            display: flex;
            backdrop-filter: blur(15px);
        }

        .diplomacy-interface.active {
            opacity: 1;
            pointer-events: auto;
        }

        .diplomacy-sidebar {
            width: 300px;
            background: rgba(20, 20, 20, 0.95);
            border-right: 2px solid #44ddff;
            padding: 20px;
            overflow-y: auto;
        }

        .diplomacy-main {
            flex: 1;
            padding: 30px;
            display: flex;
            flex-direction: column;
        }

        .diplomacy-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            color: #44ddff;
        }

        .diplomacy-title {
            font-size: 2rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .diplomacy-close {
            background: rgba(255, 68, 68, 0.2);
            border: 1px solid #ff4444;
            color: #ff4444;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .diplomacy-close:hover {
            background: rgba(255, 68, 68, 0.4);
            transform: translateY(-2px);
        }

        .nation-selector {
            margin-bottom: 20px;
        }

        .nation-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .nation-item {
            padding: 12px 15px;
            margin: 5px 0;
            background: rgba(68, 221, 255, 0.1);
            border: 1px solid rgba(68, 221, 255, 0.3);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nation-item:hover {
            background: rgba(68, 221, 255, 0.2);
            transform: translateX(5px);
        }

        .nation-item.active {
            background: rgba(68, 221, 255, 0.3);
            border-color: #44ddff;
        }

        .nation-name {
            font-weight: 600;
            color: white;
        }

        .nation-status {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: 600;
        }

        .status-ally { background: rgba(76, 175, 80, 0.3); color: #4CAF50; }
        .status-neutral { background: rgba(255, 193, 7, 0.3); color: #FFC107; }
        .status-hostile { background: rgba(244, 67, 54, 0.3); color: #F44336; }

        .relationship-meter {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            margin: 10px 0;
            overflow: hidden;
        }

        .relationship-bar {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .rel-excellent { background: linear-gradient(90deg, #4CAF50, #8BC34A); }
        .rel-good { background: linear-gradient(90deg, #8BC34A, #CDDC39); }
        .rel-neutral { background: linear-gradient(90deg, #FFC107, #FF9800); }
        .rel-poor { background: linear-gradient(90deg, #FF9800, #FF5722); }
        .rel-hostile { background: linear-gradient(90deg, #FF5722, #F44336); }

        .dialogue-container {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            position: relative;
        }

        .dialogue-avatar {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #44ddff, #007AFF);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            border: 3px solid rgba(68, 221, 255, 0.5);
        }

        .dialogue-content {
            margin-left: 90px;
            color: white;
        }

        .dialogue-speaker {
            font-weight: 600;
            color: #44ddff;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .dialogue-text {
            font-size: 16px;
            line-height: 1.5;
            margin-bottom: 20px;
        }

        .dialogue-options {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .dialogue-option {
            background: rgba(68, 221, 255, 0.1);
            border: 1px solid rgba(68, 221, 255, 0.3);
            padding: 15px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            color: white;
            position: relative;
        }

        .dialogue-option:hover {
            background: rgba(68, 221, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .dialogue-option-text {
            font-size: 14px;
            margin-bottom: 5px;
        }

        .dialogue-option-consequence {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
            font-style: italic;
        }

        .consequence-positive { color: #4CAF50; }
        .consequence-negative { color: #F44336; }
        .consequence-neutral { color: #FFC107; }

        .treaty-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(68, 221, 255, 0.2);
        }

        .treaty-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            color: #44ddff;
        }

        .treaty-type {
            font-weight: 600;
            font-size: 16px;
        }

        .treaty-terms {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .treaty-term {
            padding: 8px 12px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
            border-left: 3px solid #44ddff;
        }

        .treaty-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .treaty-btn {
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid;
        }

        .treaty-btn.accept {
            background: rgba(76, 175, 80, 0.2);
            border-color: #4CAF50;
            color: #4CAF50;
        }

        .treaty-btn.reject {
            background: rgba(244, 67, 54, 0.2);
            border-color: #F44336;
            color: #F44336;
        }

        .treaty-btn.counter {
            background: rgba(255, 193, 7, 0.2);
            border-color: #FFC107;
            color: #FFC107;
        }

        .treaty-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .relationship-impact {
            position: absolute;
            top: 50%;
            right: 30px;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #44ddff;
            border-radius: 8px;
            padding: 15px;
            min-width: 200px;
        }

        .impact-title {
            font-weight: 600;
            color: #44ddff;
            margin-bottom: 10px;
            font-size: 12px;
        }

        .impact-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            font-size: 11px;
        }

        .impact-value {
            font-weight: 600;
        }

        .impact-positive { color: #4CAF50; }
        .impact-negative { color: #F44336; }

        /* GAMEPLAY INTERFACE STYLES */
        .gameplay-interface {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            z-index: 1400;
            opacity: 1;
            pointer-events: auto;
        }

        .resource-hud {
            display: flex;
            gap: 12px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .resource-item {
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid rgba(90, 200, 250, 0.3);
            border-radius: 10px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            backdrop-filter: blur(20px);
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 140px;
            position: relative;
            overflow: hidden;
        }

        .resource-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #5AC8FA, #4CAF50, #FFC107, #ff4444);
            opacity: 0.7;
        }

        .resource-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(90, 200, 250, 0.4);
            border-color: rgba(90, 200, 250, 0.6);
        }

        .resource-icon {
            font-size: 18px;
            opacity: 0.9;
        }

        .resource-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .resource-value {
            color: #5AC8FA;
            font-weight: 700;
            font-size: 14px;
            text-shadow: 0 0 10px rgba(90, 200, 250, 0.5);
        }

        /* Resource-specific colors */
        .resource-item.budget .resource-value {
            color: #4CAF50;
            text-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }

        .resource-item.political .resource-value {
            color: #FFC107;
            text-shadow: 0 0 10px rgba(255, 193, 7, 0.5);
        }

        .resource-item.approval .resource-value {
            color: #ff4444;
            text-shadow: 0 0 10px rgba(255, 68, 68, 0.5);
        }

        .resource-item.influence .resource-value {
            color: #9C27B0;
            text-shadow: 0 0 10px rgba(156, 39, 176, 0.5);
        }

        .active-mission {
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid #5AC8FA;
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(20px);
            margin-bottom: 15px;
        }

        .mission-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            color: #5AC8FA;
        }

        .mission-icon {
            font-size: 24px;
        }

        .mission-title {
            font-size: 18px;
            font-weight: 700;
            flex: 1;
        }

        .mission-timer {
            background: rgba(255, 68, 68, 0.2);
            border: 1px solid #ff4444;
            border-radius: 6px;
            padding: 5px 10px;
            font-size: 12px;
            font-weight: 600;
            color: #ff4444;
        }

        .mission-description {
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .mission-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .layer-controls {
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid #5AC8FA;
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(20px);
        }

        .layer-control {
            display: none;
        }

        .control-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            color: #5AC8FA;
        }

        .control-header h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 700;
        }

        .readiness-indicator, .gdp-indicator, .security-level {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
        }

        .readiness-bar {
            width: 100px;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
        }

        .readiness-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff4444, #ffdd44, #44ff44);
            transition: width 0.5s ease;
        }

        .growth-positive {
            color: #4CAF50;
            font-weight: 600;
        }

        .alert-elevated {
            color: #FFC107;
            font-weight: 600;
            animation: blink 2s infinite;
        }

        .control-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(90, 200, 250, 0.1);
            border: 2px solid #5AC8FA;
            border-radius: 10px;
            padding: 15px 20px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 25px rgba(90, 200, 250, 0.4);
        }

        .action-btn.primary {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }

        .action-btn.primary:hover {
            box-shadow: 0 6px 25px rgba(76, 175, 80, 0.4);
        }

        .action-btn.secondary {
            border-color: #FFC107;
            background: rgba(255, 193, 7, 0.1);
        }

        .action-btn.secondary:hover {
            box-shadow: 0 6px 25px rgba(255, 193, 7, 0.4);
        }

        .action-btn.warning {
            border-color: #ff4444;
            background: rgba(255, 68, 68, 0.1);
        }

        .action-btn.warning:hover {
            box-shadow: 0 6px 25px rgba(255, 68, 68, 0.4);
        }

        .btn-icon {
            font-size: 32px;
            opacity: 0.8;
        }

        .btn-content {
            flex: 1;
        }

        .btn-title {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .btn-cost {
            font-size: 11px;
            opacity: 0.7;
        }

        .current-operations, .market-controls, .asset-management {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .current-operations h4, .market-controls h4, .asset-management h4 {
            margin: 0 0 10px 0;
            color: #5AC8FA;
            font-size: 14px;
        }

        .operation-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 12px;
        }

        .operation-btn {
            background: rgba(90, 200, 250, 0.2);
            border: 1px solid #5AC8FA;
            color: #5AC8FA;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .operation-btn:hover {
            background: rgba(90, 200, 250, 0.4);
        }

        .intervention-sliders {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .slider-group {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 11px;
        }

        .slider-group label {
            min-width: 100px;
            color: rgba(255, 255, 255, 0.8);
        }

        .slider-group input[type="range"] {
            flex: 1;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            outline: none;
        }

        .slider-group input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            background: #5AC8FA;
            border-radius: 50%;
            cursor: pointer;
        }

        .asset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }

        .asset-card {
            background: rgba(90, 200, 250, 0.1);
            border: 1px solid rgba(90, 200, 250, 0.3);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .asset-card:hover {
            background: rgba(90, 200, 250, 0.2);
            transform: translateY(-2px);
        }

        .asset-icon {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .asset-name {
            font-size: 11px;
            font-weight: 600;
            color: #5AC8FA;
            margin-bottom: 3px;
        }

        .asset-status {
            font-size: 9px;
            color: rgba(255, 255, 255, 0.6);
        }

        /* Additional styles for new layer controls */
        .treaty-grid, .sentiment-grid, .threat-indicators {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .treaty-card, .sentiment-region, .threat-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .treaty-card:hover, .sentiment-region:hover, .threat-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .treaty-card.active { border-color: #4CAF50; }
        .treaty-card.pending { border-color: #FFC107; }
        .treaty-card.critical { border-color: #ff4444; }

        .sentiment-region.positive { border-color: #4CAF50; }
        .sentiment-region.neutral { border-color: #FFC107; }
        .sentiment-region.negative { border-color: #ff4444; }

        .threat-item.high { border-color: #FFC107; }
        .threat-item.medium { border-color: #ff8800; }
        .threat-item.critical { border-color: #ff4444; }

        .treaty-name, .region-name, .threat-name {
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 3px;
        }

        .treaty-status, .sentiment-value, .threat-level {
            font-size: 9px;
            color: rgba(255, 255, 255, 0.6);
        }

        .project-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .project-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
        }

        .project-progress {
            flex: 1;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #ff4444, #ffdd44, #44ff44);
            transition: width 0.5s ease;
        }

        .project-btn {
            background: rgba(90, 200, 250, 0.2);
            border: 1px solid #5AC8FA;
            color: #5AC8FA;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 9px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .project-btn:hover {
            background: rgba(90, 200, 250, 0.4);
        }

        .threat-icon {
            font-size: 16px;
            margin-right: 8px;
        }

        /* NEW CLEAN UI STYLES */
        .mission-alert {
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid #ff4444;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            backdrop-filter: blur(20px);
            animation: slideIn 0.5s ease;
        }

        .alert-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .alert-icon {
            font-size: 20px;
        }

        .alert-title {
            font-size: 16px;
            font-weight: 700;
            color: #ff4444;
            flex: 1;
        }

        .alert-timer {
            background: rgba(255, 68, 68, 0.2);
            border: 1px solid #ff4444;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            color: #ff4444;
            font-weight: 600;
        }

        .alert-close {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 18px;
            cursor: pointer;
            padding: 0;
        }

        .alert-description {
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.4;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .alert-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .layer-toggle {
            text-align: center;
            margin-bottom: 15px;
        }

        .toggle-btn {
            background: rgba(90, 200, 250, 0.1);
            border: 2px solid #5AC8FA;
            border-radius: 8px;
            padding: 12px 20px;
            color: #5AC8FA;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0 auto;
        }

        .toggle-btn:hover {
            background: rgba(90, 200, 250, 0.2);
            transform: translateY(-2px);
        }

        .toggle-icon {
            font-size: 16px;
        }

        .toggle-text {
            font-size: 14px;
        }

        /* DRAGGABLE PANEL */
        .draggable-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 600px;
            max-height: 80vh;
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid #5AC8FA;
            border-radius: 12px;
            backdrop-filter: blur(20px);
            z-index: 2000;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: rgba(90, 200, 250, 0.1);
            border-bottom: 1px solid rgba(90, 200, 250, 0.3);
            border-radius: 10px 10px 0 0;
            cursor: move;
        }

        .panel-title {
            font-size: 16px;
            font-weight: 700;
            color: #5AC8FA;
        }

        .panel-controls {
            display: flex;
            gap: 5px;
        }

        .panel-btn {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 16px;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .panel-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .panel-btn.close:hover {
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
        }

        .panel-content {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        /* LAYER TABS */
        .layer-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 8px 12px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .tab-btn.active {
            background: rgba(90, 200, 250, 0.2);
            border-color: #5AC8FA;
            color: #5AC8FA;
        }

        /* LAYER CONTENT */
        .layer-tab-content {
            display: none;
        }

        .layer-tab-content.active {
            display: block;
        }

        .layer-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 6px;
            min-width: 150px;
        }

        .stat-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        .stat-bar {
            flex: 1;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
        }

        .stat-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff4444, #ffdd44, #44ff44);
            transition: width 0.5s ease;
        }

        .stat-value {
            font-size: 12px;
            font-weight: 600;
            color: #5AC8FA;
        }

        .stat-value.positive {
            color: #4CAF50;
        }

        .stat-value.warning {
            color: #FFC107;
        }

        /* ACTION GRID */
        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }

        .action-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
        }

        .action-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .action-card.primary {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }

        .action-card.primary:hover {
            background: rgba(76, 175, 80, 0.2);
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
        }

        .action-card.secondary {
            border-color: #FFC107;
            background: rgba(255, 193, 7, 0.1);
        }

        .action-card.secondary:hover {
            background: rgba(255, 193, 7, 0.2);
            box-shadow: 0 8px 25px rgba(255, 193, 7, 0.3);
        }

        .action-card.warning {
            border-color: #ff4444;
            background: rgba(255, 68, 68, 0.1);
        }

        .action-card.warning:hover {
            background: rgba(255, 68, 68, 0.2);
            box-shadow: 0 8px 25px rgba(255, 68, 68, 0.3);
        }

        .card-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .card-title {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .card-cost {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.6);
        }

        .coming-soon {
            text-align: center;
            color: rgba(255, 255, 255, 0.5);
            font-style: italic;
            padding: 40px;
        }
    </style>
</head>
<body>
    <!-- Enhanced Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-header">
            <h1 class="loading-title">COALITIONS</h1>
            <p class="loading-subtitle">Advanced Military Simulation</p>
            <p class="loading-tagline">Next-Generation Strategic Command</p>
        </div>
        
        <div class="loading-progress-container">
            <div class="loading-progress">
                <div class="loading-bar" id="loadingBar"></div>
            </div>
            <p class="loading-text" id="loadingText">Initializing advanced systems...</p>
        </div>

        <div class="loading-features">
            <div class="loading-feature"><div class="loading-feature-icon">⚡</div><div class="loading-feature-text">Dynamic Lighting</div></div>
            <div class="loading-feature"><div class="loading-feature-icon">💥</div><div class="loading-feature-text">Particle Effects</div></div>
            <div class="loading-feature"><div class="loading-feature-icon">🎖️</div><div class="loading-feature-text">Military Simulation</div></div>
            <div class="loading-feature"><div class="loading-feature-icon">🌦️</div><div class="loading-feature-text">Weather Systems</div></div>
        </div>
    </div>

    <!-- Navigation -->
    <a href="index.html" class="return-button">← NASA Earth Landing</a>
    <button class="satellite-button" id="satelliteModeBtn">🛰️ Satellite Mode</button>

    <!-- Layer Control System -->
    <div class="layer-control-panel" id="layerControlPanel">
        <div class="current-layer-info" id="currentLayerInfo">🌍 GLOBAL VIEW</div>
        <button class="layer-toggle-btn" id="layerToggleBtn">LAYERS</button>
    </div>

    <!-- Layer Selector Ring -->
    <div class="layer-selector-ring" id="layerSelectorRing">
        <div class="layer-ring">
            <button class="layer-button" data-layer="military">
                <div class="layer-icon">🎖️</div>
                <div class="layer-name">MILITARY</div>
            </button>
            <button class="layer-button" data-layer="economy">
                <div class="layer-icon">💰</div>
                <div class="layer-name">ECONOMY</div>
            </button>
            <button class="layer-button" data-layer="diplomacy">
                <div class="layer-icon">🤝</div>
                <div class="layer-name">DIPLOMACY</div>
            </button>
            <button class="layer-button" data-layer="intelligence">
                <div class="layer-icon">🕵️</div>
                <div class="layer-name">INTEL</div>
            </button>
            <button class="layer-button" data-layer="infrastructure">
                <div class="layer-icon">🏗️</div>
                <div class="layer-name">INFRA</div>
            </button>
            <button class="layer-button" data-layer="opinion">
                <div class="layer-icon">📊</div>
                <div class="layer-name">OPINION</div>
            </button>
            <button class="layer-button" data-layer="research">
                <div class="layer-icon">🔬</div>
                <div class="layer-name">RESEARCH</div>
            </button>
            <button class="layer-button" data-layer="environment">
                <div class="layer-icon">🌍</div>
                <div class="layer-name">CLIMATE</div>
            </button>
        </div>
    </div>

    <!-- Layer Data Panel -->
    <div class="layer-data-panel" id="layerDataPanel">
        <div class="layer-data-title" id="layerDataTitle">
            <span>📊</span>
            <span>Layer Statistics</span>
        </div>
        <div id="layerDataContent">
            <!-- Dynamic content will be inserted here -->
        </div>
    </div>

    <!-- Interactive Diplomacy Interface -->
    <div class="diplomacy-interface" id="diplomacyInterface">
        <div class="diplomacy-sidebar">
            <div class="nation-selector">
                <h3 style="color: #44ddff; margin-bottom: 15px;">🌍 NATIONS</h3>
                <ul class="nation-list" id="nationList">
                    <!-- Nations will be populated here -->
                </ul>
            </div>
        </div>
        
        <div class="diplomacy-main">
            <div class="diplomacy-header">
                <div class="diplomacy-title">
                    <span>🤝</span>
                    <span>DIPLOMATIC NEGOTIATIONS</span>
                </div>
                <button class="diplomacy-close" id="diplomacyClose">✕ CLOSE</button>
            </div>
            
            <div class="dialogue-container" id="dialogueContainer">
                <div class="dialogue-avatar" id="dialogueAvatar">🏛️</div>
                <div class="dialogue-content">
                    <div class="dialogue-speaker" id="dialogueSpeaker">Ambassador</div>
                    <div class="dialogue-text" id="dialogueText">
                        Welcome to diplomatic negotiations. Select a nation from the sidebar to begin discussions.
                    </div>
                    <div class="dialogue-options" id="dialogueOptions">
                        <!-- Options will be populated here -->
                    </div>
                </div>
                
                <div class="relationship-impact" id="relationshipImpact" style="display: none;">
                    <div class="impact-title">RELATIONSHIP IMPACT</div>
                    <div id="impactContent">
                        <!-- Impact preview will be shown here -->
                    </div>
                </div>
            </div>
            
            <div class="treaty-panel" id="treatyPanel" style="display: none;">
                <div class="treaty-header">
                    <div class="treaty-type" id="treatyType">Trade Agreement</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);" id="treatyStatus">UNDER NEGOTIATION</div>
                </div>
                <ul class="treaty-terms" id="treatyTerms">
                    <!-- Treaty terms will be populated here -->
                </ul>
                <div class="treaty-actions">
                    <button class="treaty-btn accept" onclick="handleTreatyAction('accept')">✓ ACCEPT</button>
                    <button class="treaty-btn reject" onclick="handleTreatyAction('reject')">✗ REJECT</button>
                    <button class="treaty-btn counter" onclick="handleTreatyAction('counter')">↔ COUNTER-OFFER</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Command Center Multi-Screen System -->
    <button class="screen-toggle" id="screenToggle">📺 COMMAND SCREENS</button>
    
    <div class="command-screens" id="commandScreens">
        <!-- Budget Monitor -->
        <div class="command-screen" id="budgetScreen">
            <div class="screen-header">
                <div class="screen-title">💰 BUDGET MONITOR</div>
                <div class="screen-status">ACTIVE</div>
            </div>
            <div class="screen-content" id="budgetContent">
                <div class="budget-item">
                    <span class="budget-label">Military</span>
                    <span class="budget-value budget-negative">-$847B</span>
                </div>
                <div class="budget-item">
                    <span class="budget-label">Intelligence</span>
                    <span class="budget-value budget-negative">-$89B</span>
                </div>
                <div class="budget-item">
                    <span class="budget-label">Infrastructure</span>
                    <span class="budget-value budget-negative">-$234B</span>
                </div>
                <div class="budget-item">
                    <span class="budget-label">Trade Revenue</span>
                    <span class="budget-value budget-positive">+$1.2T</span>
                </div>
                <div class="budget-item">
                    <span class="budget-label">Net Balance</span>
                    <span class="budget-value budget-positive">+$30B</span>
                </div>
            </div>
        </div>

        <!-- Live Events Feed -->
        <div class="command-screen" id="eventsScreen">
            <div class="screen-header">
                <div class="screen-title">📊 LIVE EVENTS</div>
                <div class="screen-status">STREAMING</div>
            </div>
            <div class="screen-content" id="eventsContent">
                <div class="event-item event-urgent">
                    <div class="event-time">12:34</div>
                    <div class="event-text">Missile threat detected</div>
                </div>
                <div class="event-item event-warning">
                    <div class="event-time">12:31</div>
                    <div class="event-text">Trade route disrupted</div>
                </div>
                <div class="event-item event-success">
                    <div class="event-time">12:28</div>
                    <div class="event-text">Diplomatic mission success</div>
                </div>
                <div class="event-item">
                    <div class="event-time">12:25</div>
                    <div class="event-text">Satellite repositioned</div>
                </div>
            </div>
        </div>

        <!-- Objectives Tracker -->
        <div class="command-screen" id="objectivesScreen">
            <div class="screen-header">
                <div class="screen-title">🎯 OBJECTIVES</div>
                <div class="screen-status">3/5 ACTIVE</div>
            </div>
            <div class="screen-content" id="objectivesContent">
                <div class="objective-item">
                    <div class="objective-title">Secure Trade Routes</div>
                    <div class="objective-progress">Progress: 87%</div>
                </div>
                <div class="objective-item objective-pending">
                    <div class="objective-title">Expand Alliance</div>
                    <div class="objective-progress">Negotiating: 2/4</div>
                </div>
                <div class="objective-item objective-pending">
                    <div class="objective-title">Tech Superiority</div>
                    <div class="objective-progress">Research: 45%</div>
                </div>
            </div>
        </div>

        <!-- Intelligence Feed -->
        <div class="command-screen" id="intelScreen">
            <div class="screen-header">
                <div class="screen-title">🕵️ INTEL FEED</div>
                <div class="screen-status">CLASSIFIED</div>
            </div>
            <div class="screen-content" id="intelContent">
                <div class="intel-feed-item">
                    <div class="intel-source">KEYHOLE-12</div>
                    <div class="intel-content">Enemy troop movement detected</div>
                </div>
                <div class="intel-feed-item">
                    <div class="intel-source">SIGINT</div>
                    <div class="intel-content">Intercepted communications</div>
                </div>
                <div class="intel-feed-item">
                    <div class="intel-source">HUMINT</div>
                    <div class="intel-content">Asset reported unusual activity</div>
                </div>
            </div>
        </div>

        <!-- Diplomacy Summary -->
        <div class="command-screen" id="diplomacyScreen">
            <div class="screen-header">
                <div class="screen-title">🤝 DIPLOMACY</div>
                <div class="screen-status">4 ACTIVE</div>
            </div>
            <div class="screen-content" id="diplomacyContent">
                <div class="event-item event-success">
                    <div class="event-time">EU</div>
                    <div class="event-text">Relations: Excellent (+89)</div>
                </div>
                <div class="event-item event-warning">
                    <div class="event-time">ASIA</div>
                    <div class="event-text">Relations: Strained (-23)</div>
                </div>
                <div class="event-item">
                    <div class="event-time">UN</div>
                    <div class="event-text">Security Council Vote: Pending</div>
                </div>
            </div>
        </div>

        <!-- Crisis Manager -->
        <div class="command-screen" id="crisisScreen">
            <div class="screen-header">
                <div class="screen-title">⚠️ CRISIS MANAGER</div>
                <div class="screen-status">1 URGENT</div>
            </div>
            <div class="screen-content" id="crisisContent">
                <div class="crisis-item">
                    <div class="crisis-level">LEVEL 3 CRISIS</div>
                    <div class="crisis-description">Oil supply disruption in Middle East</div>
                    <div class="crisis-actions">
                        <div class="crisis-action" onclick="handleCrisisAction('deploy')">DEPLOY</div>
                        <div class="crisis-action" onclick="handleCrisisAction('negotiate')">NEGOTIATE</div>
                        <div class="crisis-action" onclick="handleCrisisAction('sanction')">SANCTION</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- STRATEGIC GAMEPLAY INTERFACE -->
    <div class="gameplay-interface" id="gameplayInterface">
        <!-- Resource Management HUD -->
        <div class="resource-hud">
            <div class="resource-item budget">
                <span class="resource-icon">💰</span>
                <span class="resource-label">Budget</span>
                <span class="resource-value" id="budgetValue">$2.4T</span>
            </div>
            <div class="resource-item political">
                <span class="resource-icon">🏛️</span>
                <span class="resource-label">Political Capital</span>
                <span class="resource-value" id="politicalValue">75</span>
            </div>
            <div class="resource-item approval">
                <span class="resource-icon">📊</span>
                <span class="resource-label">Public Approval</span>
                <span class="resource-value" id="approvalValue">67%</span>
            </div>
            <div class="resource-item influence">
                <span class="resource-icon">⚡</span>
                <span class="resource-label">Influence</span>
                <span class="resource-value" id="influenceValue">82</span>
            </div>
        </div>

        <!-- Mission Alert (Only shows when active) -->
        <div class="mission-alert" id="missionAlert" style="display: none;">
            <div class="alert-header">
                <span class="alert-icon" id="alertIcon">🎯</span>
                <span class="alert-title" id="alertTitle">Mission Active</span>
                <div class="alert-timer" id="alertTimer"></div>
                <button class="alert-close" onclick="closeMissionAlert()">×</button>
            </div>
            <div class="alert-description" id="alertDescription"></div>
            <div class="alert-actions" id="alertActions"></div>
        </div>

        <!-- Layer Control Toggle -->
        <div class="layer-toggle" id="layerToggle">
            <button class="toggle-btn" onclick="toggleLayerControls()">
                <span class="toggle-icon">⚙️</span>
                <span class="toggle-text">STRATEGIC CONTROLS</span>
            </button>
        </div>
    </div>

    <!-- Draggable Layer Controls Panel -->
    <div class="draggable-panel" id="layerControlsPanel" style="display: none;">
        <div class="panel-header" id="panelHeader">
            <span class="panel-title">🎖️ STRATEGIC COMMAND</span>
            <div class="panel-controls">
                <button class="panel-btn minimize" onclick="minimizePanel()">−</button>
                <button class="panel-btn close" onclick="closePanel()">×</button>
            </div>
        </div>
        <div class="panel-content" id="panelContent">
            <!-- Layer tabs -->
            <div class="layer-tabs">
                <button class="tab-btn active" data-layer="military" onclick="switchLayerTab('military')">🎖️ Military</button>
                <button class="tab-btn" data-layer="economy" onclick="switchLayerTab('economy')">💰 Economy</button>
                <button class="tab-btn" data-layer="intelligence" onclick="switchLayerTab('intelligence')">🕵️ Intel</button>
                <button class="tab-btn" data-layer="diplomacy" onclick="switchLayerTab('diplomacy')">🤝 Diplomacy</button>
                <button class="tab-btn" data-layer="infrastructure" onclick="switchLayerTab('infrastructure')">🏗️ Infrastructure</button>
                <button class="tab-btn" data-layer="opinion" onclick="switchLayerTab('opinion')">📊 Opinion</button>
                <button class="tab-btn" data-layer="research" onclick="switchLayerTab('research')">🔬 Research</button>
                <button class="tab-btn" data-layer="environment" onclick="switchLayerTab('environment')">🌍 Environment</button>
            </div>

            <!-- Layer content -->
            <div class="layer-content">
                <!-- Military Layer -->
                <!-- Military Layer -->
                <div class="layer-tab-content active" id="militaryContent">
                    <div class="layer-stats">
                        <div class="stat-item">
                            <span class="stat-label">Combat Readiness</span>
                            <div class="stat-bar">
                                <div class="stat-fill" style="width: 85%"></div>
                            </div>
                            <span class="stat-value">85%</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Air Superiority</span>
                            <span class="stat-value" id="airSuperiority">F-35 Squadron Ready</span>
                        </div>
                    </div>
                    <div class="action-grid">
                        <button class="action-card primary" onclick="executeAction('military', 'deploy')">
                            <div class="card-icon">🚁</div>
                            <div class="card-title">Deploy Ground Forces</div>
                            <div class="card-cost">$50B, 20 Political</div>
                        </button>
                        <button class="action-card primary" onclick="deployF35Squadron()">
                            <div class="card-icon">🛩️</div>
                            <div class="card-title">Deploy F-35 Squadron</div>
                            <div class="card-cost">$15B, Air Superiority</div>
                        </button>
                        <button class="action-card secondary" onclick="executeAction('military', 'training')">
                            <div class="card-icon">🏋️</div>
                            <div class="card-title">Enhance Training</div>
                            <div class="card-cost">$25B, +15% Readiness</div>
                        </button>
                        <button class="action-card warning" onclick="executeAction('military', 'nuclear')">
                            <div class="card-icon">☢️</div>
                            <div class="card-title">Nuclear Option</div>
                            <div class="card-cost">All Political Capital</div>
                        </button>
                    </div>
                </div>

                <!-- Economy Layer -->
                <div class="layer-tab-content" id="economyContent">
                    <div class="layer-stats">
                        <div class="stat-item">
                            <span class="stat-label">GDP Growth</span>
                            <span class="stat-value positive">+3.2%</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Market Confidence</span>
                            <span class="stat-value">78%</span>
                        </div>
                    </div>
                    <div class="action-grid">
                        <button class="action-card primary" onclick="executeAction('economy', 'stimulus')">
                            <div class="card-icon">📈</div>
                            <div class="card-title">Economic Stimulus</div>
                            <div class="card-cost">$200B, +2% GDP</div>
                        </button>
                        <button class="action-card secondary" onclick="executeAction('economy', 'sanctions')">
                            <div class="card-icon">🚫</div>
                            <div class="card-title">Impose Sanctions</div>
                            <div class="card-cost">15 Influence, -20% Trade</div>
                        </button>
                        <button class="action-card warning" onclick="executeAction('economy', 'emergency')">
                            <div class="card-icon">🆘</div>
                            <div class="card-title">Emergency Measures</div>
                            <div class="card-cost">50 Political, -20% Approval</div>
                        </button>
                    </div>
                </div>

                <!-- Intelligence Layer -->
                <div class="layer-tab-content" id="intelligenceContent">
                    <div class="layer-stats">
                        <div class="stat-item">
                            <span class="stat-label">Security Alert</span>
                            <span class="stat-value warning">ELEVATED</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Intel Coverage</span>
                            <span class="stat-value">89%</span>
                        </div>
                    </div>
                    <div class="action-grid">
                        <button class="action-card primary" onclick="executeAction('intel', 'surveillance')">
                            <div class="card-icon">👁️</div>
                            <div class="card-title">Enhance Surveillance</div>
                            <div class="card-cost">$15B, +25% Coverage</div>
                        </button>
                        <button class="action-card secondary" onclick="executeAction('intel', 'cyber')">
                            <div class="card-icon">💻</div>
                            <div class="card-title">Cyber Operations</div>
                            <div class="card-cost">10 Political, Risk Exposure</div>
                        </button>
                        <button class="action-card warning" onclick="executeAction('intel', 'assassinate')">
                            <div class="card-icon">🎯</div>
                            <div class="card-title">Targeted Elimination</div>
                            <div class="card-cost">40 Political, Extreme Risk</div>
                        </button>
                    </div>
                </div>

                <!-- Other layers will be similar but with their specific actions -->
                <div class="layer-tab-content" id="diplomacyContent">
                    <div class="layer-stats">
                        <div class="stat-item">
                            <span class="stat-label">Active Treaties</span>
                            <span class="stat-value">12</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Negotiations</span>
                            <span class="stat-value">4</span>
                        </div>
                    </div>
                    <div class="action-grid">
                        <button class="action-card primary" onclick="executeAction('diplomacy', 'summit')">
                            <div class="card-icon">🏛️</div>
                            <div class="card-title">Emergency Summit</div>
                            <div class="card-cost">$30B, 25 Political</div>
                        </button>
                        <button class="action-card secondary" onclick="executeAction('diplomacy', 'sanctions')">
                            <div class="card-icon">⚖️</div>
                            <div class="card-title">Multilateral Sanctions</div>
                            <div class="card-cost">15 Influence, -20% Trade</div>
                        </button>
                        <button class="action-card warning" onclick="executeAction('diplomacy', 'isolate')">
                            <div class="card-icon">🚫</div>
                            <div class="card-title">Diplomatic Isolation</div>
                            <div class="card-cost">60 Political, -40 Influence</div>
                        </button>
                    </div>
                </div>

                <!-- Placeholder for other layers -->
                <div class="layer-tab-content" id="infrastructureContent">
                    <div class="coming-soon">Infrastructure controls coming soon...</div>
                </div>
                <div class="layer-tab-content" id="opinionContent">
                    <div class="coming-soon">Public opinion controls coming soon...</div>
                </div>
                <div class="layer-tab-content" id="researchContent">
                    <div class="coming-soon">Research controls coming soon...</div>
                </div>
                <div class="layer-tab-content" id="environmentContent">
                    <div class="coming-soon">Environmental controls coming soon...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cinematic Event Cascade Overlay -->
    <div class="event-cascade-overlay" id="eventCascadeOverlay">
        <div class="cascade-container">
            <div class="cascade-title" id="cascadeTitle">MAJOR EVENT DETECTED</div>
            <div class="cascade-description" id="cascadeDescription">Analyzing global impact...</div>
            
            <div class="cascade-effects" id="cascadeEffects">
                <!-- Dynamic effect cards will be inserted here -->
            </div>
            
            <div class="cascade-progress">
                <div class="cascade-progress-bar" id="cascadeProgressBar"></div>
            </div>
        </div>
    </div>

    <!-- Enhanced Notifications -->
    <div class="enhanced-notification" id="enhancedNotification">
        <div class="enhanced-notification-header">
            <div class="enhanced-notification-icon" id="enhancedNotificationIcon">⚡</div>
            <div class="enhanced-notification-title" id="enhancedNotificationTitle">Event Title</div>
            <div class="enhanced-notification-time" id="enhancedNotificationTime">12:34</div>
        </div>
        <div class="enhanced-notification-body" id="enhancedNotificationBody">Event description...</div>
        <div class="enhanced-notification-effects" id="enhancedNotificationEffects">
            <!-- Effect tags will be inserted here -->
        </div>
    </div>

    <!-- Basic Notification (kept for simple notifications) -->
    <div class="notification" id="notification">
        <div class="notification-title" id="notificationTitle"></div>
        <div class="notification-text" id="notificationText"></div>
    </div>

    <!-- Cesium Container -->
    <div id="cesiumContainer"></div>

    <!-- Enhanced Script -->
    <script type="module">
        let viewer;
        let isLoading = true;
        let currentLayer = 'global';
        let layerSelectorActive = false;
        let commandScreensActive = false;

        // Event cascade system
        let cascadeActive = false;
        const eventCascadeQueue = [];

        // Major events that trigger cascades
        const MAJOR_EVENTS = {
            oil_crisis: {
                title: 'OIL SUPPLY DISRUPTION',
                description: 'Middle East oil production facilities under threat',
                icon: '🛢️',
                effects: [
                    { layer: 'economy', icon: '💰', description: 'Oil prices surge +45%' },
                    { layer: 'military', icon: '🎖️', description: 'Naval forces deploying to region' },
                    { layer: 'diplomacy', icon: '🤝', description: 'Emergency UN Security Council meeting' },
                    { layer: 'opinion', icon: '📊', description: 'Public concern over energy prices' }
                ]
            },
            cyber_attack: {
                title: 'COORDINATED CYBER ATTACK',
                description: 'Critical infrastructure under digital assault',
                icon: '🔒',
                effects: [
                    { layer: 'infrastructure', icon: '🏗️', description: 'Power grid vulnerabilities detected' },
                    { layer: 'intelligence', icon: '🕵️', description: 'Counter-cyber operations initiated' },
                    { layer: 'economy', icon: '💰', description: 'Financial markets experiencing volatility' },
                    { layer: 'military', icon: '🎖️', description: 'Cyber warfare units activated' }
                ]
            },
            diplomatic_breakthrough: {
                title: 'MAJOR DIPLOMATIC BREAKTHROUGH',
                description: 'Historic peace agreement reached',
                icon: '🕊️',
                effects: [
                    { layer: 'diplomacy', icon: '🤝', description: 'Regional stability index +30%' },
                    { layer: 'economy', icon: '💰', description: 'Trade routes opening, markets rising' },
                    { layer: 'military', icon: '🎖️', description: 'Troop reduction agreements signed' },
                    { layer: 'opinion', icon: '📊', description: 'Global approval ratings improving' }
                ]
            },
            natural_disaster: {
                title: 'CATASTROPHIC NATURAL DISASTER',
                description: 'Major earthquake triggers humanitarian crisis',
                icon: '🌋',
                effects: [
                    { layer: 'infrastructure', icon: '🏗️', description: 'Critical systems damaged' },
                    { layer: 'military', icon: '🎖️', description: 'Disaster relief operations launched' },
                    { layer: 'economy', icon: '💰', description: 'Emergency funding allocated' },
                    { layer: 'opinion', icon: '📊', description: 'International solidarity growing' }
                ]
            }
        };

        // Layer definitions with enhanced data
        const LAYERS = {
            global: {
                name: 'GLOBAL VIEW',
                icon: '🌍',
                color: '#5AC8FA',
                description: 'Complete strategic overview'
            },
            military: {
                name: 'MILITARY OPERATIONS',
                icon: '🎖️',
                color: '#ff4444',
                description: 'Kinetic power projection and territorial control',
                stats: {
                    'Active Units': '2,847',
                    'Bases Online': '127',
                    'Mission Success Rate': '94.2%',
                    'Supply Status': 'OPTIMAL',
                    'Threat Level': 'MODERATE'
                }
            },
            economy: {
                name: 'ECONOMIC WARFARE',
                icon: '💰',
                color: '#ffdd44',
                description: 'Financial markets and resource control',
                stats: {
                    'GDP Growth': '+3.2%',
                    'Trade Volume': '$2.4T',
                    'Market Cap': '$89.7T',
                    'Inflation Rate': '2.1%',
                    'Currency Strength': 'STRONG'
                }
            },
            diplomacy: {
                name: 'DIPLOMATIC RELATIONS',
                icon: '🤝',
                color: '#44ddff',
                description: 'Coalition building and international relations',
                stats: {
                    'Active Treaties': '156',
                    'Alliance Strength': '87%',
                    'Negotiation Success': '71%',
                    'UN Influence': 'HIGH',
                    'Sanctions Active': '23'
                }
            },
            intelligence: {
                name: 'INTELLIGENCE OPERATIONS',
                icon: '🕵️',
                color: '#bb44ff',
                description: 'Information warfare and covert operations',
                stats: {
                    'SIGINT Coverage': '89%',
                    'HUMINT Networks': '347',
                    'Cyber Operations': 'ACTIVE',
                    'Intel Accuracy': '91.7%',
                    'Counter-Intel': 'ENHANCED'
                }
            },
            infrastructure: {
                name: 'CRITICAL INFRASTRUCTURE',
                icon: '🏗️',
                color: '#ff8844',
                description: 'Supply chains and strategic assets',
                stats: {
                    'Grid Stability': '98.4%',
                    'Supply Throughput': '2.1M tons/day',
                    'Transport Efficiency': '94%',
                    'Cyber Security': 'HARDENED',
                    'Resilience Index': 'HIGH'
                }
            },
            opinion: {
                name: 'PUBLIC OPINION',
                icon: '📊',
                color: '#44ff88',
                description: 'Domestic sentiment and international perception',
                stats: {
                    'Approval Rating': '67%',
                    'Media Sentiment': 'POSITIVE',
                    'Social Stability': '89%',
                    'Protest Risk': 'LOW',
                    'Information Control': '73%'
                }
            },
            research: {
                name: 'RESEARCH & DEVELOPMENT',
                icon: '🔬',
                color: '#88ff44',
                description: 'Technological advancement and innovation',
                stats: {
                    'R&D Investment': '$347B',
                    'Active Projects': '1,247',
                    'Breakthrough Probability': '23%',
                    'Tech Advantage': '+7.2 years',
                    'Patent Portfolio': '89,432'
                }
            },
            environment: {
                name: 'ENVIRONMENTAL FACTORS',
                icon: '🌍',
                color: '#44ff44',
                description: 'Climate impact and environmental warfare',
                stats: {
                    'Climate Risk Index': '6.2/10',
                    'Resource Depletion': '34%',
                    'Weather Manipulation': 'CLASSIFIED',
                    'Green Tech Adoption': '67%',
                    'Carbon Footprint': '-12% YoY'
                }
            }
        };

        const loadingSteps = [
             { text: 'Loading Cesium 3D Engine...', duration: 1200 },
             { text: 'Initializing NASA Earth Imagery...', duration: 1400 },
             { text: 'Loading Military Asset Database...', duration: 1600 },
             { text: 'Establishing Secure Connections...', duration: 1000 },
             { text: 'Deploying Strategic Assets...', duration: 1200 },
             { text: 'Initializing Layer Systems...', duration: 1100 },
             { text: 'Booting Command Center...', duration: 900 },
             { text: 'Loading Event Cascade Engine...', duration: 800 },
             { text: 'Initializing Diplomacy AI...', duration: 900 },
             { text: 'Optimizing Performance...', duration: 800 },
             { text: 'Final System Check...', duration: 700 }
        ];

        let currentStep = 0;
        const loadingBar = document.getElementById('loadingBar');
        const loadingText = document.getElementById('loadingText');

        let updateLoading = function() {
            if (currentStep < loadingSteps.length) {
                const step = loadingSteps[currentStep];
                const progress = ((currentStep + 1) / loadingSteps.length) * 100;
                
                loadingBar.style.width = progress + '%';
                loadingText.textContent = step.text;
                
                setTimeout(() => {
                    currentStep++;
                    updateLoading();
                }, step.duration);
            } else {
                setTimeout(initializeGame, 500);
            }
        };

        function waitForCesium() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50;
                const checkCesium = () => {
                    attempts++;
                    if (typeof Cesium !== 'undefined' && Cesium.Viewer) {
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        reject(new Error('Cesium failed to load after 5 seconds'));
                    } else {
                        setTimeout(checkCesium, 100);
                    }
                };
                checkCesium();
            });
        }

        async function initializeGame() {
            try {
                if (typeof Cesium === 'undefined') {
                    await waitForCesium();
                }
                
                const token = import.meta.env?.VITE_CESIUM_ION_TOKEN || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI5N2ZiZGE5NC1lMGZkLTQzYjktODQ0OS1jZGFkMjk0MzBkZjMiLCJpZCI6MjQzNTUsImlhdCI6MTcwMzI4OTk0OH0.8grHu8WPOr3bj1ALd32ZTVwHkl6t5WlcVvDSbKhsU8s';
                Cesium.Ion.defaultAccessToken = token;

                viewer = new Cesium.Viewer('cesiumContainer', {
                    timeline: true, 
                    animation: true,
                    baseLayerPicker: false,
                    fullscreenButton: true,
                    homeButton: true,
                    sceneModePicker: true,
                    geocoder: false,
                    navigationHelpButton: false,
                    vrButton: false,
                    terrain: Cesium.Terrain.fromWorldTerrain(),
                    requestRenderMode: false,
                    shadows: true,
                    terrainShadows: Cesium.ShadowMode.ENABLED
                });

                viewer.scene.globe.enableLighting = true;
                viewer.scene.globe.dynamicAtmosphereLighting = true;
                viewer.scene.skyAtmosphere.brightness = 1.5;
                viewer.scene.fog.enabled = true;
                viewer.scene.fog.density = 0.0002;
                
                // Ensure the home button provides a consistent view
                viewer.homeButton.viewModel.command.beforeExecute.addEventListener(function (e) {
                    e.cancel = true;
                    resetView();
                });
                
                // Add realistic 3D buildings
                const osmBuildings = await Cesium.createOsmBuildingsAsync();
                viewer.scene.primitives.add(osmBuildings);

                window.viewer = viewer;

                try {
                    await Promise.race([
                        initializeEntities(),
                        new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Entity initialization timeout after 10 seconds')), 10000)
                        )
                    ]);
                } catch (error) {
                    console.warn('⚠️ Entity initialization had issues:', error.message);
                }

                // Initialize systems
                initializeLayerSystem();
                initializeCommandCenter();
                initializeEventSystem();
                initializeDiplomacySystem();

                document.getElementById('loadingScreen').classList.add('hidden');
                isLoading = false;

                resetView();
                showNotification('COALITIONS Command Center Online', '🌍 All strategic systems operational. Select a layer to begin.');

            } catch (error) {
                console.error('❌ Initialization failed:', error);
                loadingText.textContent = 'Initialization failed. Please refresh page.';
                loadingText.style.color = '#ff4444';
            }
        }

        function initializeEventSystem() {
            // Trigger major events randomly
            setInterval(() => {
                if (Math.random() < 0.3) { // 30% chance every 60 seconds
                    triggerRandomMajorEvent();
                }
            }, 60000);

            // Process event cascade queue
            setInterval(processEventCascadeQueue, 1000);
        }

        function triggerRandomMajorEvent() {
            const eventKeys = Object.keys(MAJOR_EVENTS);
            const randomEvent = eventKeys[Math.floor(Math.random() * eventKeys.length)];
            triggerEventCascade(randomEvent);
        }

        function triggerEventCascade(eventKey) {
            if (cascadeActive) {
                eventCascadeQueue.push(eventKey);
                return;
            }

            cascadeActive = true;
            const event = MAJOR_EVENTS[eventKey];
            
            // Check if event exists
            if (!event) {
                console.error('Event not found for key:', eventKey);
                cascadeActive = false;
                return;
            }
            
            showEventCascade(event);
            showEnhancedNotification(event);
            applyCascadeEffects(event);
        }

        function showEventCascade(event) {
            // Check if event exists and has required properties
            if (!event || !event.title || !event.description) {
                console.error('Invalid event object passed to showEventCascade:', event);
                return;
            }
            
            const overlay = document.getElementById('eventCascadeOverlay');
            const title = document.getElementById('cascadeTitle');
            const description = document.getElementById('cascadeDescription');
            const effects = document.getElementById('cascadeEffects');
            const progressBar = document.getElementById('cascadeProgressBar');

            // Check if overlay elements exist
            if (!overlay || !title || !description || !effects || !progressBar) {
                console.error('Event cascade overlay elements not found');
                return;
            }

            title.textContent = event.title;
            description.textContent = event.description;

            // Create effect cards
            effects.innerHTML = event.effects.map(effect => `
                <div class="cascade-effect">
                    <div class="effect-icon">${effect.icon}</div>
                    <div class="effect-layer">${LAYERS[effect.layer].name}</div>
                    <div class="effect-description">${effect.description}</div>
                </div>
            `).join('');

            overlay.classList.add('active');

            // Animate progress bar
            setTimeout(() => {
                progressBar.style.width = '100%';
            }, 1000);

            // Hide cascade after 8 seconds
            setTimeout(() => {
                overlay.classList.remove('active');
                cascadeActive = false;
            }, 8000);
        }

        function showEnhancedNotification(eventOrOptions) {
            // Handle both old format (event object) and new format (options object)
            let title, description, icon, effects = [];
            
            if (eventOrOptions.title && eventOrOptions.description && eventOrOptions.icon) {
                // New format (options object)
                title = eventOrOptions.title;
                description = eventOrOptions.description;
                icon = eventOrOptions.icon;
                effects = eventOrOptions.effects || [];
                
                // Create dynamic notification for new format
                const notification = document.createElement('div');
                notification.className = 'enhanced-notification show';
                notification.innerHTML = `
                    <div class="notification-header">
                        <span class="notification-icon">${icon}</span>
                        <span class="notification-title">${title}</span>
                        <button class="notification-close" onclick="this.parentElement.parentElement.remove()">×</button>
                    </div>
                    <div class="notification-description">${description}</div>
                    ${effects.length > 0 ? `
                        <div class="notification-effects">
                            <div class="effects-title">Effects:</div>
                            ${effects.map(effect => `
                                <div class="effect-item">
                                    <span class="effect-layer">${effect.layer.toUpperCase()}:</span>
                                    <span class="effect-description">${effect.description}</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                `;
                
                notification.style.cssText = `
                    position: fixed; top: 20px; right: 20px; z-index: 3000;
                    background: rgba(0, 0, 0, 0.95); border: 2px solid #5AC8FA; border-radius: 12px;
                    padding: 20px; max-width: 400px; backdrop-filter: blur(20px);
                    color: white; font-family: 'Inter', sans-serif; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
                    transform: translateX(100%); animation: slideIn 0.5s ease forwards;
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.animation = 'slideOut 0.5s ease forwards';
                    setTimeout(() => notification.remove(), 500);
                }, 6000);
                
            } else {
                // Old format (event object) - use existing notification system
                const notification = document.getElementById('enhancedNotification');
                const iconElement = document.getElementById('enhancedNotificationIcon');
                const titleElement = document.getElementById('enhancedNotificationTitle');
                const timeElement = document.getElementById('enhancedNotificationTime');
                const bodyElement = document.getElementById('enhancedNotificationBody');
                const effectsContainer = document.getElementById('enhancedNotificationEffects');

                iconElement.textContent = eventOrOptions.icon;
                titleElement.textContent = eventOrOptions.title;
                timeElement.textContent = new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' });
                bodyElement.textContent = eventOrOptions.description;

                // Create effect tags
                effectsContainer.innerHTML = (eventOrOptions.effects || []).map(effect => 
                    `<div class="notification-effect-tag ${effect.layer}">${effect.layer.toUpperCase()}</div>`
                ).join('');

                notification.classList.add('show', 'urgent');

                // Hide notification after 10 seconds
                setTimeout(() => {
                    notification.classList.remove('show', 'urgent');
                }, 10000);
            }
        }

        function applyCascadeEffects(event) {
            // Apply visual effects to the globe based on event type
            switch(event.title) {
                case 'OIL SUPPLY DISRUPTION':
                    // Highlight Middle East region
                    viewer.camera.flyTo({
                        destination: Cesium.Cartesian3.fromDegrees(45, 25, 3000000),
                        duration: 3
                    });
                    break;
                case 'COORDINATED CYBER ATTACK':
                    // Create pulsing effect on infrastructure
                    viewer.scene.skyAtmosphere.brightness = 0.7;
                    setTimeout(() => {
                        viewer.scene.skyAtmosphere.brightness = 1.5;
                    }, 5000);
                    break;
                case 'MAJOR DIPLOMATIC BREAKTHROUGH':
                    // Brighten the scene
                    viewer.scene.skyAtmosphere.brightness = 2.0;
                    setTimeout(() => {
                        viewer.scene.skyAtmosphere.brightness = 1.5;
                    }, 5000);
                    break;
                case 'CATASTROPHIC NATURAL DISASTER':
                    // Shake the camera slightly
                    const originalPosition = viewer.camera.position.clone();
                    let shakeCount = 0;
                    const shakeInterval = setInterval(() => {
                        if (shakeCount < 10) {
                            const offset = 50000 * (Math.random() - 0.5);
                            viewer.camera.move(Cesium.Cartesian3.UNIT_X, offset);
                            shakeCount++;
                        } else {
                            clearInterval(shakeInterval);
                            viewer.camera.setView({ destination: originalPosition });
                        }
                    }, 200);
                    break;
            }
        }

        function processEventCascadeQueue() {
            if (!cascadeActive && eventCascadeQueue.length > 0) {
                const nextEvent = eventCascadeQueue.shift();
                triggerEventCascade(nextEvent);
            }
        }

        // Crisis action handler
        window.handleCrisisAction = function(action) {
            const actions = {
                deploy: 'Military deployment authorized - Naval forces en route to region',
                negotiate: 'Diplomatic channels opened - Emergency negotiations initiated',
                sanction: 'Economic sanctions imposed - Trade restrictions active'
            };
            
            showEnhancedNotification({
                title: `CRISIS ACTION: ${action.toUpperCase()}`,
                description: actions[action],
                icon: '⚡',
                effects: [
                    { layer: 'military', description: 'Forces mobilizing' },
                    { layer: 'diplomacy', description: 'Relations shifting' },
                    { layer: 'economy', description: 'Markets reacting' }
                ]
            });

            // Trigger a related major event
            setTimeout(() => {
                if (action === 'deploy') {
                    triggerEventCascade('oil_crisis');
                }
            }, 10000);
        };

        // INTERACTIVE DIPLOMACY SYSTEM
        let currentNation = null;
        let currentDialogue = null;
        let diplomacyActive = false;

        // Nation data with relationships and dialogue trees
        const NATIONS = {
            usa: {
                name: 'United States',
                flag: '🇺🇸',
                relationship: 85,
                status: 'ally',
                leader: 'President',
                traits: ['democratic', 'militaristic', 'economic_power'],
                dialogues: {
                    greeting: {
                        speaker: 'US Secretary of State',
                        text: 'The United States values our strategic partnership. How can we strengthen our cooperation?',
                        options: [
                            {
                                text: 'Propose joint military exercises',
                                consequence: 'Military relations +15, slight opinion boost',
                                type: 'positive',
                                leads_to: 'military_cooperation'
                            },
                            {
                                text: 'Discuss trade expansion',
                                consequence: 'Economic ties +20, trade volume increases',
                                type: 'positive',
                                leads_to: 'trade_talks'
                            },
                            {
                                text: 'Address human rights concerns',
                                consequence: 'Relations -5, moral standing +10',
                                type: 'neutral',
                                leads_to: 'rights_discussion'
                            },
                            {
                                text: 'Request intelligence sharing',
                                consequence: 'Intel cooperation +25, minor trust risk',
                                type: 'positive',
                                leads_to: 'intel_sharing'
                            }
                        ]
                    },
                    military_cooperation: {
                        speaker: 'Defense Secretary',
                        text: 'Joint exercises would demonstrate our alliance strength. When can we begin?',
                        options: [
                            {
                                text: 'Schedule immediate exercises',
                                consequence: 'Relations +20, military readiness +15',
                                type: 'positive',
                                leads_to: 'treaty_military'
                            },
                            {
                                text: 'Propose gradual buildup',
                                consequence: 'Relations +10, long-term stability',
                                type: 'neutral',
                                leads_to: 'gradual_cooperation'
                            }
                        ]
                    }
                }
            },
            china: {
                name: 'China',
                flag: '🇨🇳',
                relationship: -15,
                status: 'neutral',
                leader: 'Chairman',
                traits: ['authoritarian', 'economic_power', 'rising_power'],
                dialogues: {
                    greeting: {
                        speaker: 'Chinese Foreign Minister',
                        text: 'China seeks peaceful coexistence and mutual prosperity. What brings you to the negotiating table?',
                        options: [
                            {
                                text: 'Propose trade partnership',
                                consequence: 'Relations +25, economic interdependence',
                                type: 'positive',
                                leads_to: 'trade_talks'
                            },
                            {
                                text: 'Address territorial disputes',
                                consequence: 'Relations -10, potential tension reduction',
                                type: 'negative',
                                leads_to: 'territorial_dispute'
                            },
                            {
                                text: 'Discuss technology sharing',
                                consequence: 'Relations +15, tech advancement',
                                type: 'positive',
                                leads_to: 'tech_cooperation'
                            },
                            {
                                text: 'Raise cyber security concerns',
                                consequence: 'Relations -20, security improvement',
                                type: 'negative',
                                leads_to: 'cyber_discussion'
                            }
                        ]
                    }
                }
            },
            eu: {
                name: 'European Union',
                flag: '🇪🇺',
                relationship: 65,
                status: 'ally',
                leader: 'EU Council President',
                traits: ['democratic', 'diplomatic', 'environmental'],
                dialogues: {
                    greeting: {
                        speaker: 'EU High Representative',
                        text: 'The European Union believes in multilateralism and shared values. How can we work together?',
                        options: [
                            {
                                text: 'Strengthen climate cooperation',
                                consequence: 'Environmental progress +30, global approval',
                                type: 'positive',
                                leads_to: 'climate_accord'
                            },
                            {
                                text: 'Expand economic integration',
                                consequence: 'Trade relations +25, economic growth',
                                type: 'positive',
                                leads_to: 'trade_talks'
                            },
                            {
                                text: 'Coordinate refugee assistance',
                                consequence: 'Humanitarian standing +20, cooperation',
                                type: 'positive',
                                leads_to: 'humanitarian_aid'
                            }
                        ]
                    }
                }
            },
            russia: {
                name: 'Russia',
                flag: '🇷🇺',
                relationship: -35,
                status: 'hostile',
                leader: 'President',
                traits: ['authoritarian', 'militaristic', 'energy_power'],
                dialogues: {
                    greeting: {
                        speaker: 'Russian Foreign Minister',
                        text: 'Russia respects strength and clear positions. State your business.',
                        options: [
                            {
                                text: 'Propose energy partnership',
                                consequence: 'Relations +20, energy security boost',
                                type: 'positive',
                                leads_to: 'energy_deal'
                            },
                            {
                                text: 'Discuss arms control',
                                consequence: 'Relations +15, global stability',
                                type: 'positive',
                                leads_to: 'arms_control'
                            },
                            {
                                text: 'Address sanctions',
                                consequence: 'Relations +30 or -50 depending on approach',
                                type: 'neutral',
                                leads_to: 'sanctions_talk'
                            }
                        ]
                    }
                }
            }
        };

        // Treaty templates
        const TREATY_TEMPLATES = {
            military: {
                name: 'Military Cooperation Agreement',
                terms: [
                    'Joint military exercises twice annually',
                    'Intelligence sharing on security threats',
                    'Coordinated defense procurement',
                    'Military personnel exchange programs'
                ],
                effects: {
                    military: +25,
                    relations: +20,
                    opinion: +10
                }
            },
            trade: {
                name: 'Comprehensive Trade Agreement',
                terms: [
                    'Reduced tariffs on key commodities',
                    'Increased investment protection',
                    'Streamlined customs procedures',
                    'Joint infrastructure projects'
                ],
                effects: {
                    economy: +30,
                    relations: +15,
                    opinion: +5
                }
            },
            climate: {
                name: 'Climate Cooperation Accord',
                terms: [
                    'Joint carbon reduction targets',
                    'Green technology sharing',
                    'Environmental monitoring cooperation',
                    'Renewable energy investments'
                ],
                effects: {
                    environment: +35,
                    relations: +10,
                    opinion: +15
                }
            }
        };

        function initializeDiplomacySystem() {
            const diplomacyInterface = document.getElementById('diplomacyInterface');
            const diplomacyClose = document.getElementById('diplomacyClose');
            const nationList = document.getElementById('nationList');

            // Close diplomacy interface
            diplomacyClose.addEventListener('click', closeDiplomacyInterface);

            // Populate nation list
            Object.keys(NATIONS).forEach(nationKey => {
                const nation = NATIONS[nationKey];
                const nationItem = document.createElement('li');
                nationItem.className = 'nation-item';
                nationItem.dataset.nation = nationKey;
                
                const relationshipPercentage = Math.max(0, Math.min(100, (nation.relationship + 100) / 2));
                const relationshipClass = getRelationshipClass(nation.relationship);
                
                nationItem.innerHTML = `
                    <div>
                        <div class="nation-name">${nation.flag} ${nation.name}</div>
                        <div class="relationship-meter">
                            <div class="relationship-bar ${relationshipClass}" style="width: ${relationshipPercentage}%"></div>
                        </div>
                    </div>
                    <div class="nation-status status-${nation.status}">${nation.status.toUpperCase()}</div>
                `;
                
                nationItem.addEventListener('click', () => selectNation(nationKey));
                nationList.appendChild(nationItem);
            });
        }

        function openDiplomacyInterface() {
            const diplomacyInterface = document.getElementById('diplomacyInterface');
            diplomacyInterface.classList.add('active');
            diplomacyActive = true;
        }

        function closeDiplomacyInterface() {
            const diplomacyInterface = document.getElementById('diplomacyInterface');
            diplomacyInterface.classList.remove('active');
            diplomacyActive = false;
            currentNation = null;
            currentDialogue = null;
        }

        function selectNation(nationKey) {
            currentNation = nationKey;
            const nation = NATIONS[nationKey];
            
            // Update active nation in sidebar
            document.querySelectorAll('.nation-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.nation === nationKey) {
                    item.classList.add('active');
                }
            });

            // Start dialogue
            startDialogue('greeting');
        }

        function startDialogue(dialogueKey) {
            const nation = NATIONS[currentNation];
            const dialogue = nation.dialogues[dialogueKey];
            
            if (!dialogue) return;
            
            currentDialogue = dialogueKey;
            
            const dialogueAvatar = document.getElementById('dialogueAvatar');
            const dialogueSpeaker = document.getElementById('dialogueSpeaker');
            const dialogueText = document.getElementById('dialogueText');
            const dialogueOptions = document.getElementById('dialogueOptions');
            
            dialogueAvatar.textContent = nation.flag;
            dialogueSpeaker.textContent = `${dialogue.speaker} (${nation.name})`;
            dialogueText.textContent = dialogue.text;
            
            // Create dialogue options
            dialogueOptions.innerHTML = dialogue.options.map((option, index) => `
                <div class="dialogue-option" onclick="selectDialogueOption(${index})">
                    <div class="dialogue-option-text">${option.text}</div>
                    <div class="dialogue-option-consequence consequence-${option.type}">${option.consequence}</div>
                </div>
            `).join('');
            
            // Hide treaty panel when starting new dialogue
            document.getElementById('treatyPanel').style.display = 'none';
        }

        window.selectDialogueOption = function(optionIndex) {
            const nation = NATIONS[currentNation];
            const dialogue = nation.dialogues[currentDialogue];
            const option = dialogue.options[optionIndex];
            
            // Show relationship impact preview
            showRelationshipImpact(option);
            
            // Apply consequences after a delay
            setTimeout(() => {
                applyDialogueConsequences(option);
                
                if (option.leads_to) {
                    if (option.leads_to.startsWith('treaty_')) {
                        const treatyType = option.leads_to.replace('treaty_', '');
                        showTreatyNegotiation(treatyType);
                    } else if (nation.dialogues[option.leads_to]) {
                        startDialogue(option.leads_to);
                    }
                }
                
                // Hide impact preview
                document.getElementById('relationshipImpact').style.display = 'none';
            }, 3000);
        };

        function showRelationshipImpact(option) {
            const impactPanel = document.getElementById('relationshipImpact');
            const impactContent = document.getElementById('impactContent');
            
            // Parse consequence text to show specific impacts
            const impacts = [];
            if (option.consequence.includes('Relations')) {
                const match = option.consequence.match(/Relations ([+-]\d+)/);
                if (match) {
                    impacts.push({ label: 'Relations', value: match[1], type: match[1].startsWith('+') ? 'positive' : 'negative' });
                }
            }
            
            impactContent.innerHTML = impacts.map(impact => `
                <div class="impact-item">
                    <span>${impact.label}</span>
                    <span class="impact-value impact-${impact.type}">${impact.value}</span>
                </div>
            `).join('');
            
            impactPanel.style.display = 'block';
        }

        function applyDialogueConsequences(option) {
            const nation = NATIONS[currentNation];
            
            // Parse and apply relationship changes
            if (option.consequence.includes('Relations')) {
                const match = option.consequence.match(/Relations ([+-]\d+)/);
                if (match) {
                    const change = parseInt(match[1]);
                    nation.relationship = Math.max(-100, Math.min(100, nation.relationship + change));
                    updateNationDisplay();
                    
                    // Show notification
                    showEnhancedNotification({
                        title: 'DIPLOMATIC CONSEQUENCE',
                        description: `Relations with ${nation.name}: ${change > 0 ? '+' : ''}${change}`,
                        icon: '🤝',
                        effects: [{ layer: 'diplomacy', description: `${nation.name} relationship changed` }]
                    });
                }
            }
        }

        function updateNationDisplay() {
            const nationItem = document.querySelector(`[data-nation="${currentNation}"]`);
            const nation = NATIONS[currentNation];
            
            if (nationItem) {
                const relationshipBar = nationItem.querySelector('.relationship-bar');
                const relationshipPercentage = Math.max(0, Math.min(100, (nation.relationship + 100) / 2));
                const relationshipClass = getRelationshipClass(nation.relationship);
                
                relationshipBar.className = `relationship-bar ${relationshipClass}`;
                relationshipBar.style.width = `${relationshipPercentage}%`;
                
                // Update status
                const statusElement = nationItem.querySelector('.nation-status');
                nation.status = getStatusFromRelationship(nation.relationship);
                statusElement.textContent = nation.status.toUpperCase();
                statusElement.className = `nation-status status-${nation.status}`;
            }
        }

        function getRelationshipClass(relationship) {
            if (relationship >= 70) return 'rel-excellent';
            if (relationship >= 30) return 'rel-good';
            if (relationship >= -30) return 'rel-neutral';
            if (relationship >= -70) return 'rel-poor';
            return 'rel-hostile';
        }

        function getStatusFromRelationship(relationship) {
            if (relationship >= 50) return 'ally';
            if (relationship >= -30) return 'neutral';
            return 'hostile';
        }

        function showTreatyNegotiation(treatyType) {
            const treatyPanel = document.getElementById('treatyPanel');
            const treatyTypeElement = document.getElementById('treatyType');
            const treatyTerms = document.getElementById('treatyTerms');
            const treatyStatus = document.getElementById('treatyStatus');
            
            const treaty = TREATY_TEMPLATES[treatyType];
            if (!treaty) return;
            
            treatyTypeElement.textContent = treaty.name;
            treatyStatus.textContent = 'UNDER NEGOTIATION';
            
            treatyTerms.innerHTML = treaty.terms.map(term => 
                `<li class="treaty-term">${term}</li>`
            ).join('');
            
            treatyPanel.style.display = 'block';
        }

        window.handleTreatyAction = function(action) {
            const nation = NATIONS[currentNation];
            const actions = {
                accept: {
                    message: `Treaty accepted with ${nation.name}`,
                    relationshipChange: +30,
                    icon: '✅'
                },
                reject: {
                    message: `Treaty rejected by ${nation.name}`,
                    relationshipChange: -15,
                    icon: '❌'
                },
                counter: {
                    message: `Counter-offer proposed to ${nation.name}`,
                    relationshipChange: 0,
                    icon: '↔️'
                }
            };
            
            const actionData = actions[action];
            nation.relationship += actionData.relationshipChange;
            updateNationDisplay();
            
            showEnhancedNotification({
                title: 'TREATY NEGOTIATION',
                description: actionData.message,
                icon: actionData.icon,
                effects: [{ layer: 'diplomacy', description: `${nation.name} relations affected` }]
            });
            
            document.getElementById('treatyPanel').style.display = 'none';
            
            if (action === 'accept') {
                triggerEventCascade('diplomatic_breakthrough');
            }
        };

        function initializeCommandCenter() {
            const screenToggle = document.getElementById('screenToggle');
            const commandScreens = document.getElementById('commandScreens');

            // Toggle command screens
            screenToggle.addEventListener('click', () => {
                commandScreensActive = !commandScreensActive;
                commandScreens.classList.toggle('active', commandScreensActive);
                screenToggle.textContent = commandScreensActive ? '📺 HIDE SCREENS' : '📺 COMMAND SCREENS';
            });

            // Start real-time updates
            startRealTimeUpdates();
        }

        function startRealTimeUpdates() {
            // Update budget data every 5 seconds
            setInterval(updateBudgetData, 5000);
            
            // Add new events every 10-30 seconds
            setInterval(addRandomEvent, Math.random() * 20000 + 10000);
            
            // Update intel feed every 15 seconds
            setInterval(updateIntelFeed, 15000);
            
            // Update diplomacy status every 30 seconds
            setInterval(updateDiplomacyStatus, 30000);
        }

        function updateBudgetData() {
            const budgetContent = document.getElementById('budgetContent');
            const items = [
                { label: 'Military', value: -847 - Math.floor(Math.random() * 50), negative: true },
                { label: 'Intelligence', value: -89 - Math.floor(Math.random() * 10), negative: true },
                { label: 'Infrastructure', value: -234 - Math.floor(Math.random() * 30), negative: true },
                { label: 'Trade Revenue', value: 1200 + Math.floor(Math.random() * 100), positive: true },
                { label: 'Net Balance', value: 30 + Math.floor(Math.random() * 50 - 25) }
            ];

            budgetContent.innerHTML = items.map(item => {
                const colorClass = item.positive ? 'budget-positive' : 
                                  item.negative ? 'budget-negative' : 
                                  item.value > 0 ? 'budget-positive' : 'budget-negative';
                const sign = item.value > 0 ? '+' : '';
                const unit = item.label === 'Trade Revenue' || item.label === 'Net Balance' ? 'B' : 'B';
                
                return `<div class="budget-item">
                    <span class="budget-label">${item.label}</span>
                    <span class="budget-value ${colorClass}">${sign}$${Math.abs(item.value)}${unit}</span>
                </div>`;
            }).join('');
        }

        function addRandomEvent() {
            const events = [
                { text: 'Satellite repositioned', type: '', urgent: false },
                { text: 'Trade route secured', type: 'success', urgent: false },
                { text: 'Cyber attack detected', type: 'urgent', urgent: true },
                { text: 'Diplomatic meeting scheduled', type: '', urgent: false },
                { text: 'Weather system approaching', type: 'warning', urgent: false },
                { text: 'Intel asset compromised', type: 'urgent', urgent: true },
                { text: 'Supply convoy delayed', type: 'warning', urgent: false },
                { text: 'Alliance treaty signed', type: 'success', urgent: false }
            ];

            const eventsContent = document.getElementById('eventsContent');
            const randomEvent = events[Math.floor(Math.random() * events.length)];
            const currentTime = new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' });
            
            const eventElement = document.createElement('div');
            eventElement.className = `event-item ${randomEvent.type ? 'event-' + randomEvent.type : ''}`;
            eventElement.innerHTML = `
                <div class="event-time">${currentTime}</div>
                <div class="event-text">${randomEvent.text}</div>
            `;

            eventsContent.insertBefore(eventElement, eventsContent.firstChild);
            
            // Keep only last 4 events
            while (eventsContent.children.length > 4) {
                eventsContent.removeChild(eventsContent.lastChild);
            }
        }

        function updateIntelFeed() {
            const intelSources = ['KEYHOLE-12', 'LACROSSE-5', 'SIGINT', 'HUMINT', 'CRYSTAL-2', 'ONYX-1'];
            const intelReports = [
                'Unusual troop movement detected',
                'Communication intercept successful',
                'Asset provided valuable intelligence',
                'Enemy facility surveillance ongoing',
                'Signal pattern analysis complete',
                'Covert operation status update'
            ];

            const intelContent = document.getElementById('intelContent');
            const randomSource = intelSources[Math.floor(Math.random() * intelSources.length)];
            const randomReport = intelReports[Math.floor(Math.random() * intelReports.length)];
            
            const intelElement = document.createElement('div');
            intelElement.className = 'intel-feed-item';
            intelElement.innerHTML = `
                <div class="intel-source">${randomSource}</div>
                <div class="intel-content">${randomReport}</div>
            `;

            intelContent.insertBefore(intelElement, intelContent.firstChild);
            
            // Keep only last 3 intel items
            while (intelContent.children.length > 3) {
                intelContent.removeChild(intelContent.lastChild);
            }
        }

        function updateDiplomacyStatus() {
            const regions = [
                { name: 'EU', relation: 89 + Math.floor(Math.random() * 10 - 5) },
                { name: 'ASIA', relation: -23 + Math.floor(Math.random() * 20 - 10) },
                { name: 'AFRICA', relation: 45 + Math.floor(Math.random() * 30 - 15) }
            ];

            const diplomacyContent = document.getElementById('diplomacyContent');
            diplomacyContent.innerHTML = regions.map(region => {
                const status = region.relation > 50 ? 'Excellent' : 
                              region.relation > 0 ? 'Good' : 
                              region.relation > -50 ? 'Strained' : 'Poor';
                const eventType = region.relation > 50 ? 'event-success' : 
                                 region.relation < 0 ? 'event-warning' : '';
                
                return `<div class="event-item ${eventType}">
                    <div class="event-time">${region.name}</div>
                    <div class="event-text">Relations: ${status} (${region.relation > 0 ? '+' : ''}${region.relation})</div>
                </div>`;
            }).join('') + 
            `<div class="event-item">
                <div class="event-time">UN</div>
                <div class="event-text">Security Council Vote: ${Math.random() > 0.5 ? 'Pending' : 'Scheduled'}</div>
            </div>`;
        }

        function initializeLayerSystem() {
            const layerToggleBtn = document.getElementById('layerToggleBtn');
            const layerSelectorRing = document.getElementById('layerSelectorRing');
            const layerButtons = document.querySelectorAll('.layer-button');

            // Toggle layer selector ring
            layerToggleBtn.addEventListener('click', () => {
                layerSelectorActive = !layerSelectorActive;
                layerSelectorRing.classList.toggle('active', layerSelectorActive);
                layerToggleBtn.textContent = layerSelectorActive ? 'CLOSE' : 'LAYERS';
            });

            // Layer button interactions
            layerButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const layerName = button.dataset.layer;
                    switchToLayer(layerName);
                });
            });

            // Initialize with global layer
            updateLayerUI('global');
        }

        function switchToLayer(layerName) {
            if (layerName === currentLayer) return;
            
            currentLayer = layerName;
            
            // Hide layer selector
            layerSelectorActive = false;
            document.getElementById('layerSelectorRing').classList.remove('active');
            document.getElementById('layerToggleBtn').textContent = 'LAYERS';
            
            // Update UI theme
            updateLayerUI(layerName);
            
            // Apply layer-specific visualization
            applyLayerVisualization(layerName);
            
            // Show notification
            const layer = LAYERS[layerName];
            showNotification(`${layer.name} ACTIVE`, layer.description);
        }

        function updateLayerUI(layerName) {
            const layer = LAYERS[layerName];
            const body = document.body;
            const currentLayerInfo = document.getElementById('currentLayerInfo');
            const layerDataPanel = document.getElementById('layerDataPanel');
            const layerDataTitle = document.getElementById('layerDataTitle');
            const layerDataContent = document.getElementById('layerDataContent');
            
            // Update body class for theme
            body.className = `layer-${layerName}`;
            
            // Update current layer display
            currentLayerInfo.innerHTML = `${layer.icon} ${layer.name}`;
            
            // Update layer buttons
            document.querySelectorAll('.layer-button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.layer === layerName) {
                    btn.classList.add('active');
                }
            });
            
            // Update data panel
            if (layer.stats) {
                layerDataTitle.innerHTML = `<span>${layer.icon}</span><span>${layer.name}</span>`;
                layerDataContent.innerHTML = Object.entries(layer.stats).map(([label, value]) => 
                    `<div class="layer-stat">
                        <span class="layer-stat-label">${label}</span>
                        <span class="layer-stat-value">${value}</span>
                    </div>`
                ).join('');
                layerDataPanel.classList.add('active');
            } else {
                layerDataPanel.classList.remove('active');
            }
        }

        function applyLayerVisualization(layerName) {
            // This is where we'll add layer-specific visual effects
            switch(layerName) {
                case 'military':
                    applyMilitaryLayer();
                    break;
                case 'economy':
                    applyEconomyLayer();
                    break;
                case 'diplomacy':
                    applyDiplomacyLayer();
                    break;
                case 'intelligence':
                    applyIntelligenceLayer();
                    break;
                case 'infrastructure':
                    applyInfrastructureLayer();
                    break;
                case 'opinion':
                    applyOpinionLayer();
                    break;
                case 'research':
                    applyResearchLayer();
                    break;
                case 'environment':
                    applyEnvironmentLayer();
                    break;
                default:
                    applyGlobalLayer();
            }
        }

        function applyMilitaryLayer() {
            // Enhanced military visualization
            viewer.scene.skyAtmosphere.brightness = 0.8;
            viewer.scene.fog.density = 0.0001;
            
            // Show military units with enhanced visibility
            viewer.entities.values.forEach(entity => {
                if (entity.name && (entity.name.includes('Squadron') || entity.name.includes('Convoy') || entity.name.includes('Fleet'))) {
                    if (entity.model) {
                        entity.model.color = Cesium.Color.RED.withAlpha(0.9);
                        entity.model.silhouetteColor = Cesium.Color.YELLOW;
                        entity.model.silhouetteSize = 2;
                    }
                }
            });
        }

        function applyEconomyLayer() {
            // Economy visualization with trade routes
            viewer.scene.skyAtmosphere.brightness = 1.2;
            
            // Highlight economic centers
            viewer.entities.values.forEach(entity => {
                if (entity.name && entity.name.includes('City')) {
                    if (entity.billboard) {
                        entity.billboard.color = Cesium.Color.GOLD;
                        entity.billboard.scale = 1.5;
                    }
                }
            });
        }

        function applyDiplomacyLayer() {
            // Diplomacy with relation lines between nations
            viewer.scene.skyAtmosphere.brightness = 1.0;
            
            // Enhance diplomatic facilities
            viewer.entities.values.forEach(entity => {
                if (entity.name && (entity.name.includes('Brussels') || entity.name.includes('UN'))) {
                    if (entity.model) {
                        entity.model.color = Cesium.Color.CYAN.withAlpha(0.8);
                    }
                }
            });
            
            // Show enhanced notification with diplomacy access
            showEnhancedNotification({
                title: 'DIPLOMATIC LAYER ACTIVE',
                description: 'Press Ctrl+D to open diplomatic negotiations interface',
                icon: '🤝',
                effects: [{ layer: 'diplomacy', description: 'Interactive negotiations available' }]
            });
        }

        function applyIntelligenceLayer() {
            // Enhanced surveillance appearance
            viewer.scene.skyAtmosphere.brightness = 0.6;
            viewer.scene.fog.density = 0.0005;
            
            // Highlight intelligence assets
            viewer.entities.values.forEach(entity => {
                if (entity.name && entity.name.includes('Satellite')) {
                    if (entity.model) {
                        entity.model.color = Cesium.Color.PURPLE.withAlpha(0.9);
                        entity.model.silhouetteColor = Cesium.Color.WHITE;
                        entity.model.silhouetteSize = 1;
                    }
                }
            });
        }

        function applyInfrastructureLayer() {
            // Infrastructure focus with enhanced buildings
            viewer.scene.skyAtmosphere.brightness = 1.1;
            
            // Highlight infrastructure
            viewer.entities.values.forEach(entity => {
                if (entity.name && (entity.name.includes('Base') || entity.name.includes('Command'))) {
                    if (entity.model) {
                        entity.model.color = Cesium.Color.ORANGE.withAlpha(0.8);
                    }
                }
            });
        }

        function applyOpinionLayer() {
            // Opinion layer with dynamic coloring
            viewer.scene.skyAtmosphere.brightness = 1.3;
            
            // Color cities based on opinion (mock data)
            viewer.entities.values.forEach(entity => {
                if (entity.name && entity.name.includes('City')) {
                    if (entity.billboard) {
                        entity.billboard.color = Math.random() > 0.5 ? Cesium.Color.GREEN : Cesium.Color.YELLOW;
                    }
                }
            });
        }

        function applyResearchLayer() {
            // Research centers highlighted
            viewer.scene.skyAtmosphere.brightness = 1.4;
            
            viewer.entities.values.forEach(entity => {
                if (entity.name && entity.name.includes('Research')) {
                    if (entity.model) {
                        entity.model.color = Cesium.Color.LIME.withAlpha(0.9);
                    }
                }
            });
        }

        function applyEnvironmentLayer() {
            // Environmental data visualization
            viewer.scene.skyAtmosphere.brightness = 1.2;
            viewer.scene.fog.density = 0.0003;
            
            // Show environmental indicators
            viewer.entities.values.forEach(entity => {
                if (entity.billboard && entity.name) {
                    entity.billboard.color = Cesium.Color.LIGHTGREEN;
                }
            });
        }

        function applyGlobalLayer() {
            // Reset to normal view
            viewer.scene.skyAtmosphere.brightness = 1.5;
            viewer.scene.fog.density = 0.0002;
            
            // Reset all entity colors
            viewer.entities.values.forEach(entity => {
                if (entity.model) {
                    entity.model.color = Cesium.Color.WHITE;
                    entity.model.silhouetteSize = 0;
                }
                if (entity.billboard) {
                    entity.billboard.color = Cesium.Color.WHITE;
                    entity.billboard.scale = 1.0;
                }
            });
        }

        // Keep existing functions for entity initialization, satellite mode, etc.
        async function initializeEntities() {
             viewer.scene.globe.show = true;
             viewer.scene.skyBox.show = true;

            const militaryBases = [
                { name: 'Pentagon Command', pos: [-77.056, 38.871, 0] },
                { name: 'NORAD Cheyenne', pos: [-104.846, 38.743, 1800] },
                { name: 'NATO Brussels HQ', pos: [4.425, 50.878, 0] },
                { name: 'Pacific Fleet Pearl', pos: [-157.864, 21.311, 0] },
                { name: 'Ramstein Air Base', pos: [7.603, 49.437, 240] }
            ];

            let entityCount = 0;
            militaryBases.forEach(base => {
                viewer.entities.add({
                    name: base.name,
                    position: Cesium.Cartesian3.fromDegrees(base.pos[0], base.pos[1], base.pos[2]),
                    model: {
                        uri: 'https://assets.cesium.com/im/model/CommandCenter/CommandCenter.gltf',
                        scale: 200.0,
                        minimumPixelSize: 100
                    },
                    label: {
                        text: `🏛️ ${base.name}`,
                        font: '12pt Arial',
                        fillColor: Cesium.Color.WHITE,
                        outlineColor: Cesium.Color.BLACK,
                        outlineWidth: 2,
                        style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                        verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                        pixelOffset: new Cesium.Cartesian2(0, -20),
                        scaleByDistance: new Cesium.NearFarScalar(500000, 1.2, 5000000, 0.4)
                    }
                });
                entityCount++;
            });

            await deployMobileUnits();
            await deploySatellites();
            await deployNavalUnits();
            await addMajorCities();
        }

        async function deployMobileUnits() {
            const unitFormations = [
                { name: 'Alpha Squadron', type: 'air', path: [[-95, 39, 8000], [-90, 41, 8000], [-85, 40, 8000]] },
                { name: 'Bravo Convoy', type: 'ground', path: [[-77, 38.8, 0], [-77.1, 38.9, 0], [-77.2, 39, 0]] },
                { name: 'Charlie Fleet', type: 'naval', path: [[-75, 35, 0], [-70, 36, 0], [-65, 37, 0]] }
            ];

            const models = {
                air: 'https://assets.cesium.com/im/model/CesiumAir/Cesium_Air.gltf',
                ground: 'https://assets.cesium.com/im/model/GroundVehicle/GroundVehicle.gltf',
                naval: 'https://assets.cesium.com/im/model/USSCarrier/USSCarrier.gltf'
            };

            unitFormations.forEach(formation => {
                formation.path.forEach((pos, index) => {
                    viewer.entities.add({
                        name: `${formation.name} - Unit ${index + 1}`,
                        position: Cesium.Cartesian3.fromDegrees(pos[0], pos[1], pos[2]),
                        model: {
                            uri: models[formation.type],
                            scale: formation.type === 'naval' ? 50 : 100,
                            minimumPixelSize: 32
                        },
                        path: { material: Cesium.Color.YELLOW.withAlpha(0.5), width: 3, leadTime: 600, trailTime: 300 }
                    });
                });
            });
        }

        async function deploySatellites() {
            for (let i = 0; i < 12; i++) {
                const longitude = (i * 30) - 180;
                viewer.entities.add({
                    name: `GPS Satellite ${i + 1}`,
                    position: Cesium.Cartesian3.fromDegrees(longitude, 0, 20200000),
                    model: {
                        uri: 'https://assets.cesium.com/im/model/Satellite/satellite.gltf',
                        scale: 100.0,
                        minimumPixelSize: 64
                    },
                    label: { text: '🛰️', font: '16pt Arial', fillColor: Cesium.Color.GOLD, scaleByDistance: new Cesium.NearFarScalar(10000000, 1.0, 50000000, 0.3) }
                });
            }
        }

        async function deployNavalUnits() {
            const oceanRoutes = [
                { name: 'Atlantic Patrol', route: [[-70, 35], [-60, 40], [-50, 45]] },
                { name: 'Pacific Guard', route: [[-150, 30], [-140, 35], [-130, 40]] },
                { name: 'Mediterranean Task Force', route: [[5, 35], [15, 40], [25, 42]] }
            ];
            oceanRoutes.forEach(patrol => {
                patrol.route.forEach((pos, index) => {
                    viewer.entities.add({
                        name: `${patrol.name} - Ship ${index + 1}`,
                        position: Cesium.Cartesian3.fromDegrees(pos[0], pos[1], 0),
                        model: {
                            uri: 'https://assets.cesium.com/im/model/USSCarrier/USSCarrier.gltf',
                            scale: 100,
                            minimumPixelSize: 64
                        },
                        path: { material: Cesium.Color.BLUE.withAlpha(0.6), width: 2, leadTime: 1800, trailTime: 900 }
                    });
                });
            });
        }

        async function addMajorCities() {
            const cityDataSource = new Cesium.CustomDataSource('cities');
            viewer.dataSources.add(cityDataSource);

            // Clustering options
            cityDataSource.clustering.enabled = true;
            cityDataSource.clustering.pixelRange = 100;
            cityDataSource.clustering.minimumClusterSize = 5;

            // Custom cluster appearance
            cityDataSource.clustering.clusterEvent.addEventListener(function(clusteredEntities, cluster) {
                cluster.label.show = false;
                cluster.billboard.show = true;
                cluster.billboard.image = 'https://assets.cesium.com/im/pin/cluster-sm.png';
                cluster.billboard.verticalOrigin = Cesium.VerticalOrigin.BOTTOM;
            });

            const cities = [
                { name: 'Tokyo', pos: [139.6917, 35.6895, 0] },
                { name: 'Delhi', pos: [77.1025, 28.7041, 0] },
                { name: 'Shanghai', pos: [121.4737, 31.2304, 0] },
                { name: 'São Paulo', pos: [-46.6333, -23.5505, 0] },
                { name: 'Mexico City', pos: [-99.1332, 19.4326, 0] },
                { name: 'Cairo', pos: [31.2357, 30.0444, 0] },
                { name: 'Mumbai', pos: [72.8777, 19.0760, 0] },
                { name: 'Beijing', pos: [116.3912, 39.9075, 0] },
                { name: 'Seoul', pos: [126.9780, 37.5665, 0] },
                { name: 'Istanbul', pos: [28.9784, 41.0082, 0] },
                { name: 'Lagos', pos: [3.3792, 6.4531, 0] },
                { name: 'Moscow', pos: [37.6173, 55.7558, 0] },
                { name: 'Paris', pos: [2.3522, 48.8566, 0] },
                { name: 'London', pos: [-0.1276, 51.5074, 0] },
                { name: 'Sydney', pos: [151.2153, -33.8568, 0] },
                { name: 'Rome', pos: [12.4964, 41.9028, 0] },
                { name: 'Berlin', pos: [13.4049, 52.5200, 0] },
                { name: 'Madrid', pos: [-3.7038, 40.4168, 0] },
                { name: 'Toronto', pos: [-79.3832, 43.6510, 0] },
                { name: 'Dubai', pos: [55.2962, 25.2769, 0] }
            ];

            cities.forEach(city => {
                cityDataSource.entities.add({
                    name: city.name,
                    position: Cesium.Cartesian3.fromDegrees(city.pos[0], city.pos[1], city.pos[2]),
                    billboard: {
                        image: 'https://assets.cesium.com/im/pin/pin-sm.png',
                        verticalOrigin: Cesium.VerticalOrigin.BOTTOM
                    },
                    label: {
                        text: city.name,
                        font: '10pt Arial',
                        fillColor: Cesium.Color.WHITE,
                        outlineColor: Cesium.Color.BLACK,
                        outlineWidth: 2,
                        style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                        verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                        pixelOffset: new Cesium.Cartesian2(0, -15),
                        scaleByDistance: new Cesium.NearFarScalar(1.5e6, 1.0, 8.0e6, 0.0)
                    }
                });
            });
        }

        function resetView() {
            viewer.camera.flyHome(2.5);
            showNotification('View Reset', '🌍 Global overview restored.');
        }
        
        document.addEventListener('keydown', (event) => {
            if (isLoading) return;
            if (event.key.toLowerCase() === 'r') {
                resetView();
            }
            // Layer shortcuts
            if (event.key >= '1' && event.key <= '8') {
                const layerIndex = parseInt(event.key) - 1;
                const layerNames = ['military', 'economy', 'diplomacy', 'intelligence', 'infrastructure', 'opinion', 'research', 'environment'];
                if (layerNames[layerIndex]) {
                    switchToLayer(layerNames[layerIndex]);
                }
            }
            // Screen toggle shortcut
            if (event.key.toLowerCase() === 's' && event.ctrlKey) {
                event.preventDefault();
                document.getElementById('screenToggle').click();
            }
            // Trigger demo major event
            if (event.key.toLowerCase() === 'e' && event.ctrlKey) {
                event.preventDefault();
                triggerRandomMajorEvent();
            }
            // Open diplomacy interface
            if (event.key.toLowerCase() === 'd' && event.ctrlKey) {
                event.preventDefault();
                openDiplomacyInterface();
            }
        });

        // Advanced Satellite Surveillance System (keeping existing implementation)
        let satelliteMode = false;
        let currentSatellite = null;
        const satelliteModeBtn = document.getElementById('satelliteModeBtn');
        satelliteModeBtn.addEventListener('click', toggleSatelliteMode);

        // Realistic satellite constellation
        const satellites = [
            { name: 'KEYHOLE-12', type: 'optical', altitude: 400000, resolution: 0.1, position: [0, 0], coverage: 'Global' },
            { name: 'LACROSSE-5', type: 'radar', altitude: 680000, resolution: 1.0, position: [30, 50], coverage: 'Europe' },
            { name: 'CRYSTAL-2', type: 'infrared', altitude: 600000, resolution: 0.15, position: [-120, 35], coverage: 'Americas' },
            { name: 'ONYX-1', type: 'signals', altitude: 850000, resolution: 5.0, position: [140, 35], coverage: 'Asia-Pacific' }
        ];

        function toggleSatelliteMode() {
            satelliteMode = !satelliteMode;
            if (satelliteMode) {
                satelliteModeBtn.textContent = '🛰️ Exit Surveillance';
                satelliteModeBtn.style.background = 'linear-gradient(135deg, rgba(255, 0, 0, 0.9) 0%, rgba(150, 0, 0, 1) 100%)';
                enterSurveillanceMode();
            } else {
                satelliteModeBtn.textContent = '🛰️ Satellite Mode';
                satelliteModeBtn.style.background = 'linear-gradient(135deg, rgba(255, 68, 68, 0.9) 0%, rgba(200, 0, 0, 1) 100%)';
                exitSurveillanceMode();
            }
        }

        function enterSurveillanceMode() {
            currentSatellite = satellites[0];
            createSurveillanceHUD();
            
            viewer.camera.flyTo({
                destination: Cesium.Cartesian3.fromDegrees(0, 0, currentSatellite.altitude),
                orientation: { heading: 0, pitch: Cesium.Math.toRadians(-85), roll: 0 },
                duration: 3.0
            });
            
            viewer.scene.screenSpaceCameraController.enableRotate = false;
            viewer.scene.screenSpaceCameraController.enableTilt = false;
            viewer.scene.screenSpaceCameraController.maximumZoomDistance = 2000000;
            viewer.scene.screenSpaceCameraController.minimumZoomDistance = 200000;
            
            showNotification('SURVEILLANCE ACTIVE', `${currentSatellite.name} online - ${currentSatellite.resolution}m resolution`);
        }

        function createSurveillanceHUD() {
            const hud = document.createElement('div');
            hud.id = 'surveillanceHUD';
            hud.innerHTML = `
                <div class="hud-overlay">
                    <div class="classification-header">TOP SECRET // COMINT // NOFORN</div>
                    <div class="mission-clock" id="missionClock"></div>
                    
                    <div class="satellite-status">
                        <div class="sat-name" id="satName">${currentSatellite.name}</div>
                        <div class="sat-data">
                            ALT: <span id="satAlt">${(currentSatellite.altitude/1000).toFixed(0)}</span>km |
                            RES: <span id="satRes">${currentSatellite.resolution}</span>m |
                            TYPE: <span id="satType">${currentSatellite.type.toUpperCase()}</span>
                        </div>
                    </div>
                    
                    <div class="crosshairs">
                        <div class="crosshair-horizontal"></div>
                        <div class="crosshair-vertical"></div>
                        <div class="targeting-circle"></div>
                    </div>
                    
                    <div class="coordinates-display" id="coordsDisplay">
                        TARGET: LAT ---.------ LON ---.------
                    </div>
                    
                    <div class="satellite-selector">
                        ${satellites.map((sat, i) => 
                            `<button class="sat-btn ${i === 0 ? 'active' : ''}" onclick="window.switchTo(${i})">
                                ${sat.name}<br><small>${sat.coverage}</small>
                            </button>`
                        ).join('')}
                    </div>
                    
                    <div class="mission-status">SURVEILLANCE ACTIVE</div>
                </div>
                
                <style>
                .hud-overlay {
                    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
                    pointer-events: none; font-family: 'Courier New', monospace;
                    color: #00ff00; z-index: 2000; text-shadow: 0 0 10px #00ff00;
                }
                
                .classification-header {
                    position: absolute; top: 15px; left: 50%; transform: translateX(-50%);
                    color: #ff0000; font-weight: bold; font-size: 14px;
                    animation: blink 2s infinite;
                }
                
                .mission-clock {
                    position: absolute; top: 15px; right: 20px;
                    background: rgba(0,0,0,0.8); padding: 5px 15px; border: 1px solid #00ff00;
                }
                
                .satellite-status {
                    position: absolute; top: 60px; left: 20px;
                    background: rgba(0,0,0,0.8); padding: 15px; border: 1px solid #00ff00;
                    border-radius: 5px;
                }
                
                .sat-name { color: #ffff00; font-size: 16px; font-weight: bold; margin-bottom: 8px; }
                .sat-data { font-size: 11px; }
                
                .crosshairs {
                    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
                    width: 300px; height: 300px;
                }
                
                .crosshair-horizontal {
                    position: absolute; top: 50%; left: 0; width: 100%; height: 2px;
                    background: #ff0000; box-shadow: 0 0 10px #ff0000;
                }
                
                .crosshair-vertical {
                    position: absolute; left: 50%; top: 0; width: 2px; height: 100%;
                    background: #ff0000; box-shadow: 0 0 10px #ff0000;
                }
                
                .targeting-circle {
                    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
                    width: 200px; height: 200px; border: 2px solid #00ff00; border-radius: 50%;
                    animation: pulse 2s infinite; opacity: 0.7;
                }
                
                .coordinates-display {
                    position: absolute; bottom: 60px; left: 50%; transform: translateX(-50%);
                    background: rgba(0,0,0,0.8); padding: 10px 20px; border: 1px solid #ffff00;
                    color: #ffff00; font-size: 14px;
                }
                
                .satellite-selector {
                    position: absolute; top: 200px; right: 20px;
                    background: rgba(0,0,0,0.9); border: 1px solid #00ff00; border-radius: 5px;
                    padding: 15px; pointer-events: auto;
                }
                
                .sat-btn {
                    display: block; width: 100%; padding: 8px; margin: 5px 0;
                    background: rgba(0,255,0,0.1); border: 1px solid #00ff00; color: #00ff00;
                    font-family: 'Courier New', monospace; font-size: 10px; cursor: pointer;
                    transition: all 0.3s ease;
                }
                
                .sat-btn:hover { background: rgba(0,255,0,0.3); box-shadow: 0 0 15px #00ff00; }
                .sat-btn.active { background: rgba(255,0,0,0.3); border-color: #ff0000; color: #ff0000; }
                
                .mission-status {
                    position: absolute; bottom: 20px; right: 20px;
                    color: #ff0000; font-weight: bold; animation: blink 1.5s infinite;
                }
                
                @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0.4; } }
                @keyframes pulse { 0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.7; }
                                  50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; } }
                </style>
            `;
            
            document.body.appendChild(hud);
            startMissionClock();
            trackTargetCoordinates();
        }

        window.switchTo = function(index) {
            currentSatellite = satellites[index];
            
            document.querySelectorAll('.sat-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === index);
            });
            
            document.getElementById('satName').textContent = currentSatellite.name;
            document.getElementById('satAlt').textContent = (currentSatellite.altitude/1000).toFixed(0);
            document.getElementById('satRes').textContent = currentSatellite.resolution;
            document.getElementById('satType').textContent = currentSatellite.type.toUpperCase();
            
            viewer.camera.flyTo({
                destination: Cesium.Cartesian3.fromDegrees(
                    currentSatellite.position[0], 
                    currentSatellite.position[1], 
                    currentSatellite.altitude
                ),
                orientation: { heading: 0, pitch: Cesium.Math.toRadians(-85), roll: 0 },
                duration: 2.5
            });
            
            showNotification('SATELLITE SWITCH', `Now viewing from ${currentSatellite.name}`);
        };

        function startMissionClock() {
            function updateClock() {
                const clock = document.getElementById('missionClock');
                if (clock && satelliteMode) {
                    clock.textContent = new Date().toISOString().replace('T', ' ').substring(0, 19) + ' UTC';
                }
            }
            updateClock();
            if (satelliteMode) setTimeout(startMissionClock, 1000);
        }

        function trackTargetCoordinates() {
            viewer.cesiumWidget.canvas.addEventListener('mousemove', (event) => {
                if (!satelliteMode) return;
                
                const pick = viewer.camera.pickEllipsoid(new Cesium.Cartesian2(event.clientX, event.clientY));
                if (pick) {
                    const cartographic = Cesium.Cartographic.fromCartesian(pick);
                    const lon = Cesium.Math.toDegrees(cartographic.longitude);
                    const lat = Cesium.Math.toDegrees(cartographic.latitude);
                    
                    const coordsDisplay = document.getElementById('coordsDisplay');
                    if (coordsDisplay) {
                        coordsDisplay.textContent = `TARGET: LAT ${lat.toFixed(6)} LON ${lon.toFixed(6)}`;
                    }
                }
            });
        }

        function exitSurveillanceMode() {
            const hud = document.getElementById('surveillanceHUD');
            if (hud) hud.remove();
            
            viewer.scene.screenSpaceCameraController.enableRotate = true;
            viewer.scene.screenSpaceCameraController.enableTilt = true;
            viewer.scene.screenSpaceCameraController.maximumZoomDistance = 40075000;
            viewer.scene.screenSpaceCameraController.minimumZoomDistance = 1.0;
            
            resetView();
            showNotification('SURVEILLANCE TERMINATED', 'Normal camera controls restored');
        }

        function showNotification(title, text) {
            const notification = document.getElementById('notification');
            const titleElement = document.getElementById('notificationTitle');
            const textElement = document.getElementById('notificationText');
            
            titleElement.textContent = title;
            textElement.textContent = text;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // Start the enhanced loading sequence
        updateLoading();

        // COMPREHENSIVE GAMEPLAY SYSTEM
        let gameState = {
            resources: {
                budget: 2400, // Billions
                political: 75,
                approval: 67,
                influence: 82
            },
            layerStats: {
                military: { readiness: 85, operations: ['desert_shield'] },
                economy: { gdp: 3.2, confidence: 78, spending: { defense: 35, infrastructure: 25, social: 40 } },
                intelligence: { alertLevel: 'ELEVATED', coverage: 89, activeOps: 3 },
                diplomacy: { activeNegotiations: 4, treaties: 12 },
                infrastructure: { stability: 98, projects: 7 },
                opinion: { media: 'POSITIVE', stability: 89, protests: 'LOW' },
                research: { projects: 1247, investment: 347, breakthroughs: 3 },
                environment: { riskIndex: 6.2, initiatives: 8 }
            },
            activeMission: null,
            currentLayerControl: null,
            activeScenarios: []
        };

        // Dynamic scenarios that create gameplay challenges
        const SCENARIOS = {
            cyber_warfare: {
                title: 'CYBER WARFARE ESCALATION',
                description: 'Foreign hackers have penetrated critical infrastructure. Multiple power grids are at risk.',
                urgency: 'HIGH',
                timeLimit: 180, // 3 minutes
                icon: '💻',
                triggers: ['infrastructure', 'intelligence', 'military'],
                consequences: {
                    success: { approval: +15, influence: +20, budget: -50 },
                    failure: { approval: -25, influence: -30, infrastructure: -40 }
                },
                actions: [
                    { layer: 'intelligence', action: 'cyber_counter', label: 'Deploy Cyber Defense', cost: { budget: 30, political: 10 } },
                    { layer: 'military', action: 'cyber_strike', label: 'Offensive Cyber Strike', cost: { political: 25, influence: -10 } },
                    { layer: 'infrastructure', action: 'shutdown', label: 'Emergency Grid Shutdown', cost: { approval: -20, budget: -100 } }
                ]
            },
            economic_crisis: {
                title: 'GLOBAL FINANCIAL MELTDOWN',
                description: 'Major markets are crashing. Unemployment is spiking. Emergency economic measures needed.',
                urgency: 'CRITICAL',
                timeLimit: 240,
                icon: '📉',
                triggers: ['economy', 'opinion'],
                consequences: {
                    success: { approval: +20, budget: -300, influence: +15 },
                    failure: { approval: -40, political: -50, unrest: true }
                },
                actions: [
                    { layer: 'economy', action: 'stimulus', label: 'Emergency Stimulus Package', cost: { budget: 500, political: 20 } },
                    { layer: 'economy', action: 'bailout', label: 'Bank Bailout Program', cost: { budget: 800, approval: -15 } },
                    { layer: 'opinion', action: 'reassurance', label: 'Public Reassurance Campaign', cost: { budget: 50, political: 10 } }
                ]
            },
            diplomatic_crisis: {
                title: 'ALLIANCE BREAKDOWN',
                description: 'Key ally threatens to withdraw from mutual defense treaty. Regional stability at risk.',
                urgency: 'HIGH',
                timeLimit: 300,
                icon: '🤝',
                triggers: ['diplomacy', 'military'],
                consequences: {
                    success: { influence: +25, political: +15 },
                    failure: { influence: -40, military: -20, treaties: -3 }
                },
                actions: [
                    { layer: 'diplomacy', action: 'negotiate', label: 'Emergency Summit', cost: { political: 30, budget: 25 } },
                    { layer: 'economy', action: 'incentives', label: 'Economic Incentives', cost: { budget: 200, influence: +10 } },
                    { layer: 'military', action: 'reassure', label: 'Military Reassurance', cost: { budget: 100, political: 15 } }
                ]
            }
        };

        function initializeGameplaySystem() {
            // Replace old command screens with new gameplay interface
            document.getElementById('screenToggle').style.display = 'none';
            document.getElementById('commandScreens').style.display = 'none';
            
            // Start resource updates
            updateResourceDisplay();
            
            // Generate initial scenario after 30 seconds
            setTimeout(generateRandomScenario, 30000);
            
            // Regular scenario generation
            setInterval(generateRandomScenario, 120000); // Every 2 minutes
            
            // Resource decay over time
            setInterval(processResourceDecay, 15000); // Every 15 seconds
        }

        function updateResourceDisplay() {
            // Format budget to 1 decimal place and add proper formatting
            const budget = gameState.resources.budget;
            const budgetFormatted = budget >= 1000 ? 
                `$${(budget/1000).toFixed(1)}T` : 
                `$${budget.toFixed(0)}B`;
            
            // Format political capital to whole number
            const political = Math.round(gameState.resources.political);
            
            // Format approval to 1 decimal place
            const approval = gameState.resources.approval.toFixed(1);
            
            // Format influence to whole number
            const influence = Math.round(gameState.resources.influence);
            
            // Update display values
            document.getElementById('budgetValue').textContent = budgetFormatted;
            document.getElementById('politicalValue').textContent = political;
            document.getElementById('approvalValue').textContent = `${approval}%`;
            document.getElementById('influenceValue').textContent = influence;
            
            // Add visual indicators for resource levels
            updateResourceIndicators();
        }

        function updateResourceIndicators() {
            const budgetItem = document.querySelector('.resource-item.budget');
            const politicalItem = document.querySelector('.resource-item.political');
            const approvalItem = document.querySelector('.resource-item.approval');
            const influenceItem = document.querySelector('.resource-item.influence');
            
            // Budget indicators (green = good, red = low)
            if (gameState.resources.budget < 500) {
                budgetItem.style.borderColor = 'rgba(255, 68, 68, 0.6)';
                budgetItem.style.boxShadow = '0 0 15px rgba(255, 68, 68, 0.3)';
            } else if (gameState.resources.budget > 2000) {
                budgetItem.style.borderColor = 'rgba(76, 175, 80, 0.6)';
                budgetItem.style.boxShadow = '0 0 15px rgba(76, 175, 80, 0.3)';
            } else {
                budgetItem.style.borderColor = 'rgba(90, 200, 250, 0.3)';
                budgetItem.style.boxShadow = 'none';
            }
            
            // Political capital indicators
            if (gameState.resources.political < 30) {
                politicalItem.style.borderColor = 'rgba(255, 68, 68, 0.6)';
                politicalItem.style.boxShadow = '0 0 15px rgba(255, 68, 68, 0.3)';
            } else if (gameState.resources.political > 70) {
                politicalItem.style.borderColor = 'rgba(255, 193, 7, 0.6)';
                politicalItem.style.boxShadow = '0 0 15px rgba(255, 193, 7, 0.3)';
            } else {
                politicalItem.style.borderColor = 'rgba(90, 200, 250, 0.3)';
                politicalItem.style.boxShadow = 'none';
            }
            
            // Approval indicators
            if (gameState.resources.approval < 40) {
                approvalItem.style.borderColor = 'rgba(255, 68, 68, 0.6)';
                approvalItem.style.boxShadow = '0 0 15px rgba(255, 68, 68, 0.3)';
            } else if (gameState.resources.approval > 80) {
                approvalItem.style.borderColor = 'rgba(76, 175, 80, 0.6)';
                approvalItem.style.boxShadow = '0 0 15px rgba(76, 175, 80, 0.3)';
            } else {
                approvalItem.style.borderColor = 'rgba(90, 200, 250, 0.3)';
                approvalItem.style.boxShadow = 'none';
            }
            
            // Influence indicators
            if (gameState.resources.influence < 50) {
                influenceItem.style.borderColor = 'rgba(255, 68, 68, 0.6)';
                influenceItem.style.boxShadow = '0 0 15px rgba(255, 68, 68, 0.3)';
            } else if (gameState.resources.influence > 80) {
                influenceItem.style.borderColor = 'rgba(156, 39, 176, 0.6)';
                influenceItem.style.boxShadow = '0 0 15px rgba(156, 39, 176, 0.3)';
            } else {
                influenceItem.style.borderColor = 'rgba(90, 200, 250, 0.3)';
                influenceItem.style.boxShadow = 'none';
            }
        }

        function generateRandomScenario() {
            if (gameState.activeMission) return; // Don't generate if mission active
            
            const scenarioKeys = Object.keys(SCENARIOS);
            const randomScenario = scenarioKeys[Math.floor(Math.random() * scenarioKeys.length)];
            activateScenario(randomScenario);
        }

        function activateScenario(scenarioKey) {
            const scenario = SCENARIOS[scenarioKey];
            gameState.activeMission = {
                ...scenario,
                key: scenarioKey,
                timeRemaining: scenario.timeLimit,
                actionsCompleted: []
            };
            
            updateMissionDisplay();
            startMissionTimer();
            
            // Show dramatic event cascade
            triggerEventCascade(scenarioKey);
        }



        function formatCosts(costs) {
            return Object.entries(costs).map(([resource, amount]) => {
                const sign = amount > 0 ? '+' : '';
                return `${sign}${amount} ${resource}`;
            }).join(', ');
        }

        function startMissionTimer() {
            const timer = setInterval(() => {
                if (!gameState.activeMission) {
                    clearInterval(timer);
                    return;
                }
                
                gameState.activeMission.timeRemaining--;
                const minutes = Math.floor(gameState.activeMission.timeRemaining / 60);
                const seconds = gameState.activeMission.timeRemaining % 60;
                document.getElementById('alertTimer').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                if (gameState.activeMission.timeRemaining <= 0) {
                    failMission();
                    clearInterval(timer);
                }
            }, 1000);
        }

        window.executeMissionAction = function(actionIndex) {
            const mission = gameState.activeMission;
            const action = mission.actions[actionIndex];
            
            // Check if player can afford the action
            if (!canAffordAction(action.cost)) {
                showEnhancedNotification({
                    title: 'INSUFFICIENT RESOURCES',
                    description: 'Cannot execute action - insufficient resources',
                    icon: '❌',
                    effects: [{ layer: 'system', description: 'Action blocked' }]
                });
                return;
            }
            
            // Apply costs
            applyResourceChanges(action.cost);
            
            // Mark action as completed
            mission.actionsCompleted.push(actionIndex);
            
            // Show action result
            showEnhancedNotification({
                title: 'ACTION EXECUTED',
                description: `${action.label} initiated`,
                icon: '⚡',
                effects: [{ layer: action.layer, description: 'Operation in progress' }]
            });
            
            // Check if mission is complete
            if (mission.actionsCompleted.length >= 2 || mission.timeRemaining < 30) {
                setTimeout(completeMission, 3000);
            }
            
            updateMissionDisplay();
            updateResourceDisplay();
        };

        function canAffordAction(costs) {
            return Object.entries(costs).every(([resource, amount]) => {
                if (amount < 0) return true; // Negative costs are benefits
                return gameState.resources[resource] >= amount;
            });
        }

        function applyResourceChanges(changes) {
            Object.entries(changes).forEach(([resource, amount]) => {
                gameState.resources[resource] = Math.max(0, Math.min(100, gameState.resources[resource] - amount));
                if (resource === 'budget') {
                    gameState.resources[resource] = Math.max(0, gameState.resources[resource] - amount);
                }
            });
        }

        function completeMission() {
            const mission = gameState.activeMission;
            const success = mission.actionsCompleted.length >= 2;
            
            const consequences = success ? mission.consequences.success : mission.consequences.failure;
            applyResourceChanges(Object.fromEntries(Object.entries(consequences).map(([k, v]) => [k, -v])));
            
            showEnhancedNotification({
                title: success ? 'MISSION SUCCESS' : 'MISSION FAILED',
                description: success ? 'Crisis resolved through decisive action' : 'Failed to adequately respond to crisis',
                icon: success ? '✅' : '❌',
                effects: [{ layer: 'global', description: success ? 'Stability increased' : 'Global instability rising' }]
            });
            
            if (success) {
                triggerEventCascade('diplomatic_breakthrough');
            } else {
                triggerEventCascade('cyber_attack'); // Trigger a problem cascade
            }
            
            gameState.activeMission = null;
            updateMissionDisplay();
            updateResourceDisplay();
        }

        function failMission() {
            completeMission(); // This will trigger the failure path
        }

        function processResourceDecay() {
            // Simulate natural resource decay/changes
            gameState.resources.approval = Math.max(20, gameState.resources.approval - Math.random() * 2);
            gameState.resources.political = Math.max(10, gameState.resources.political - Math.random() * 1.5);
            gameState.resources.budget += (Math.random() - 0.5) * 50; // Budget can fluctuate
            gameState.resources.influence += (Math.random() - 0.5) * 3;
            
            // Clamp values
            gameState.resources.approval = Math.min(100, gameState.resources.approval);
            gameState.resources.political = Math.min(100, gameState.resources.political);
            gameState.resources.influence = Math.min(100, Math.max(0, gameState.resources.influence));
            
            updateResourceDisplay();
        }

        // Layer-specific action handlers
        window.executeAction = function(layer, action) {
            const actions = {
                military: {
                    deploy: { cost: { budget: 50, political: 20 }, effect: 'Forces deployed to strategic position' },
                    training: { cost: { budget: 25 }, effect: 'Military readiness increased by 15%' },
                    nuclear: { cost: { political: 75, approval: -30 }, effect: 'Nuclear deterrent activated - Global tensions rising' }
                },
                economy: {
                    stimulus: { cost: { budget: 200, political: 10 }, effect: 'Economic growth stimulated, GDP +2%' },
                    sanctions: { cost: { influence: 15, approval: -5 }, effect: 'Economic sanctions imposed on hostile nations' },
                    emergency: { cost: { political: 50, approval: -20 }, effect: 'Emergency economic powers activated' }
                },
                intel: {
                    surveillance: { cost: { budget: 15, political: 5 }, effect: 'Intelligence coverage increased by 25%' },
                    cyber: { cost: { political: 10 }, effect: 'Cyber operations initiated - Gathering intelligence' },
                    assassinate: { cost: { political: 40, influence: -25, approval: -15 }, effect: 'High-value target eliminated - Extreme diplomatic fallout' }
                },
                diplomacy: {
                    summit: { cost: { budget: 30, political: 25 }, effect: 'Emergency diplomatic summit convened - Regional tensions addressed' },
                    sanctions: { cost: { influence: 15, approval: -5 }, effect: 'Multilateral sanctions imposed - Economic pressure applied' },
                    isolate: { cost: { political: 60, influence: -40 }, effect: 'Diplomatic isolation imposed - Extreme international backlash' }
                },
                infrastructure: {
                    upgrade: { cost: { budget: 150 }, effect: 'Critical infrastructure upgraded - System efficiency increased by 25%' },
                    smart_grid: { cost: { budget: 75, influence: -5 }, effect: 'Smart grid deployed - Increased efficiency but cyber vulnerability' },
                    lockdown: { cost: { approval: -15, influence: -10 }, effect: 'Infrastructure locked down - Maximum security, economic impact' }
                },
                opinion: {
                    campaign: { cost: { budget: 25, political: 5 }, effect: 'Media campaign launched - Public approval increased' },
                    transparency: { cost: { political: 15, influence: -10 }, effect: 'Transparency initiative - Trust increased but intel exposed' },
                    propaganda: { cost: { political: 40, approval: -25 }, effect: 'Information control activated - Narrative controlled but democratic risk' }
                },
                research: {
                    quantum: { cost: { budget: 100, political: 10 }, effect: 'Quantum computing research accelerated - Future technological dominance' },
                    ai: { cost: { budget: 80, political: 15 }, effect: 'AI warfare systems developed - Strategic advantage with ethical concerns' },
                    bio: { cost: { political: 80, influence: -50, approval: -30 }, effect: 'Bioweapons research initiated - Global treaty violations' }
                },
                environment: {
                    green_deal: { cost: { budget: 300, political: 20, approval: -10 }, effect: 'Green energy transition initiated - Economic disruption but climate leadership' },
                    climate_war: { cost: { budget: 150, political: 30, influence: -20 }, effect: 'Climate intervention deployed - Geoengineering with unknown consequences' },
                    ignore: { cost: { approval: -30, influence: -25 }, effect: 'Climate priorities deprioritized - Economic focus but environmental consequences' }
                }
            };
            
            const actionData = actions[layer][action];
            if (!actionData) return;
            
            if (!canAffordAction(actionData.cost)) {
                showEnhancedNotification({
                    title: 'INSUFFICIENT RESOURCES',
                    description: 'Cannot execute action - check resource requirements',
                    icon: '❌',
                    effects: [{ layer: layer, description: 'Action blocked' }]
                });
                return;
            }
            
            applyResourceChanges(actionData.cost);
            
            showEnhancedNotification({
                title: `${layer.toUpperCase()} ACTION EXECUTED`,
                description: actionData.effect,
                icon: '⚡',
                effects: [{ layer: layer, description: 'Operation completed' }]
            });
            
            // Trigger cascading effects
            if (action === 'nuclear') {
                setTimeout(() => triggerEventCascade('cyber_attack'), 5000);
            } else if (action === 'assassinate') {
                setTimeout(() => triggerEventCascade('diplomatic_breakthrough'), 8000);
            }
            
            updateResourceDisplay();
        };

        window.adjustSpending = function(category, value) {
            gameState.layerStats.economy.spending[category] = parseInt(value);
            
            // Update display
            const sliderSpan = document.querySelector(`#${category}Slider`).nextElementSibling;
            if (sliderSpan) sliderSpan.textContent = `${value}%`;
            
            // Apply economic effects
            const totalSpending = Object.values(gameState.layerStats.economy.spending).reduce((a, b) => a + b, 0);
            if (totalSpending > 100) {
                showEnhancedNotification({
                    title: 'BUDGET OVERRUN',
                    description: 'Spending allocation exceeds 100% - Economic instability rising',
                    icon: '⚠️',
                    effects: [{ layer: 'economy', description: 'Budget deficit increasing' }]
                });
                
                gameState.resources.budget -= 50;
                gameState.resources.approval -= 5;
                updateResourceDisplay();
            }
        };

        window.deployAsset = function(assetType) {
            const deploymentCosts = {
                humint: { budget: 20, political: 5 },
                sigint: { budget: 35, political: 3 },
                cyber: { budget: 15, political: 8 }
            };
            
            const cost = deploymentCosts[assetType];
            if (!canAffordAction(cost)) return;
            
            applyResourceChanges(cost);
            
            showEnhancedNotification({
                title: 'INTELLIGENCE ASSET DEPLOYED',
                description: `${assetType.toUpperCase()} operations expanded`,
                icon: '🕵️',
                effects: [{ layer: 'intelligence', description: 'Coverage increased' }]
            });
            
            updateResourceDisplay();
        };

        window.manageOperation = function(operationId) {
            showEnhancedNotification({
                title: 'OPERATION MANAGEMENT',
                description: `Managing ${operationId.replace('_', ' ').toUpperCase()}`,
                icon: '🎖️',
                effects: [{ layer: 'military', description: 'Operation parameters adjusted' }]
            });
        };

        // Additional layer-specific functions
        window.adjustResearch = function(category, value) {
            gameState.layerStats.research.allocation = gameState.layerStats.research.allocation || {};
            gameState.layerStats.research.allocation[category] = parseInt(value);
            
            // Update display
            const slider = document.getElementById(`${category}Research`);
            const sliderSpan = slider ? slider.nextElementSibling : null;
            if (sliderSpan) sliderSpan.textContent = `${value}%`;
            
            // Apply research effects based on allocation
            const totalAllocation = Object.values(gameState.layerStats.research.allocation).reduce((a, b) => a + b, 0);
            if (totalAllocation > 100) {
                showEnhancedNotification({
                    title: 'RESEARCH OVERALLOCATION',
                    description: 'Research funding exceeds capacity - Efficiency declining',
                    icon: '⚠️',
                    effects: [{ layer: 'research', description: 'Budget strain detected' }]
                });
            }
        };

        window.manageTreaty = function(treatyType) {
            const treaties = {
                nato: { name: 'NATO Alliance', cost: { political: 10, influence: 5 }, effect: 'Alliance strengthened' },
                trade: { name: 'Trade Agreement', cost: { budget: 20, political: 5 }, effect: 'Economic cooperation expanded' },
                peace: { name: 'Peace Accord', cost: { political: 25, influence: 15 }, effect: 'Regional stability restored' }
            };
            
            const treaty = treaties[treatyType];
            if (!treaty) return;
            
            if (!canAffordAction(treaty.cost)) {
                showEnhancedNotification({
                    title: 'INSUFFICIENT RESOURCES',
                    description: `Cannot manage ${treaty.name} - insufficient resources`,
                    icon: '❌',
                    effects: [{ layer: 'diplomacy', description: 'Treaty management blocked' }]
                });
                return;
            }
            
            applyResourceChanges(treaty.cost);
            
            showEnhancedNotification({
                title: 'TREATY MANAGEMENT',
                description: `${treaty.name} - ${treaty.effect}`,
                icon: '🤝',
                effects: [{ layer: 'diplomacy', description: 'International relations adjusted' }]
            });
            
            updateResourceDisplay();
        };

        window.deployF35Squadron = function() {
            const cost = { budget: 15, political: 5 };
            
            if (!canAffordAction(cost)) {
                showEnhancedNotification({
                    title: 'INSUFFICIENT RESOURCES',
                    description: 'Cannot deploy F-35 squadron - insufficient budget',
                    icon: '❌',
                    effects: [{ layer: 'military', description: 'Deployment blocked' }]
                });
                return;
            }
            
            applyResourceChanges(cost);
            
            // Deploy the squadron
            if (!squadronActive) {
                deploySquadron();
            }
            
            // Update air superiority status
            document.getElementById('airSuperiority').textContent = 'F-35 Squadron Deployed';
            document.getElementById('airSuperiority').style.color = '#4CAF50';
            
            showEnhancedNotification({
                title: 'F-35 SQUADRON DEPLOYED',
                description: 'Squadron of 4 F-35s deployed for air superiority mission',
                icon: '🛩️',
                effects: [
                    { layer: 'military', description: 'Air superiority established' },
                    { layer: 'intelligence', description: 'Enhanced aerial surveillance' }
                ]
            });
            
            updateResourceDisplay();
        };

        // Enhanced layer switching to show interactive controls
        function switchToLayerWithControls(layerName) {
            // Hide all layer controls
            document.querySelectorAll('.layer-control').forEach(control => {
                control.style.display = 'none';
            });
            
            // Show layer controls panel
            const layerControls = document.getElementById('layerControls');
            layerControls.style.display = 'block';
            
            // Show specific layer control
            const controlMap = {
                'military': 'militaryControl',
                'economy': 'economyControl',
                'intelligence': 'intelControl',
                'diplomacy': 'diplomacyControl',
                'infrastructure': 'infrastructureControl',
                'opinion': 'opinionControl',
                'research': 'researchControl',
                'environment': 'environmentControl'
            };
            
            if (controlMap[layerName]) {
                document.getElementById(controlMap[layerName]).style.display = 'block';
                gameState.currentLayerControl = layerName;
            }
            
            // Call original layer switch
            switchToLayer(layerName);
        }

        // NEW CLEAN UI FUNCTIONS
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };
        let panelPosition = { x: 0, y: 0 };

        window.toggleLayerControls = function() {
            const panel = document.getElementById('layerControlsPanel');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                initializeDraggable();
            } else {
                panel.style.display = 'none';
            }
        };

        window.closePanel = function() {
            document.getElementById('layerControlsPanel').style.display = 'none';
        };

        window.minimizePanel = function() {
            const panel = document.getElementById('layerControlsPanel');
            const content = document.getElementById('panelContent');
            if (content.style.display === 'none') {
                content.style.display = 'block';
            } else {
                content.style.display = 'none';
            }
        };

        window.switchLayerTab = function(layerName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-layer="${layerName}"]`).classList.add('active');

            // Update tab content
            document.querySelectorAll('.layer-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${layerName}Content`).classList.add('active');

            // Update panel title
            const titles = {
                military: '🎖️ MILITARY COMMAND',
                economy: '💰 ECONOMIC STRATEGY',
                intelligence: '🕵️ INTELLIGENCE OPS',
                diplomacy: '🤝 DIPLOMATIC AFFAIRS',
                infrastructure: '🏗️ INFRASTRUCTURE',
                opinion: '📊 PUBLIC OPINION',
                research: '🔬 RESEARCH & TECH',
                environment: '🌍 ENVIRONMENTAL'
            };
            document.querySelector('.panel-title').textContent = titles[layerName] || '🎖️ STRATEGIC COMMAND';
        };

        window.closeMissionAlert = function() {
            document.getElementById('missionAlert').style.display = 'none';
        };

        function initializeDraggable() {
            const panel = document.getElementById('layerControlsPanel');
            const header = document.getElementById('panelHeader');

            header.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDrag);
        }

        function startDrag(e) {
            if (e.target.classList.contains('panel-btn')) return;
            
            isDragging = true;
            const panel = document.getElementById('layerControlsPanel');
            const rect = panel.getBoundingClientRect();
            
            dragOffset.x = e.clientX - rect.left;
            dragOffset.y = e.clientY - rect.top;
            
            panel.style.cursor = 'grabbing';
        }

        function drag(e) {
            if (!isDragging) return;
            
            const panel = document.getElementById('layerControlsPanel');
            const x = e.clientX - dragOffset.x;
            const y = e.clientY - dragOffset.y;
            
            // Keep panel within viewport bounds
            const maxX = window.innerWidth - panel.offsetWidth;
            const maxY = window.innerHeight - panel.offsetHeight;
            
            panel.style.left = Math.max(0, Math.min(x, maxX)) + 'px';
            panel.style.top = Math.max(0, Math.min(y, maxY)) + 'px';
            panel.style.transform = 'none';
        }

        function stopDrag() {
            isDragging = false;
            const panel = document.getElementById('layerControlsPanel');
            panel.style.cursor = 'grab';
        }

        // Update mission display for new clean UI
        function updateMissionDisplay() {
            const mission = gameState.activeMission;
            const alert = document.getElementById('missionAlert');
            
            if (!mission) {
                alert.style.display = 'none';
                return;
            }
            
            alert.style.display = 'block';
            document.getElementById('alertIcon').textContent = mission.icon;
            document.getElementById('alertTitle').textContent = mission.title;
            document.getElementById('alertDescription').textContent = mission.description;
            
            // Create action buttons
            const actionsHtml = mission.actions.map((action, index) => `
                <button class="action-card ${action.layer === 'economy' ? 'primary' : action.layer === 'military' ? 'warning' : 'secondary'}" 
                        onclick="executeMissionAction(${index})" 
                        ${mission.actionsCompleted.includes(index) ? 'disabled' : ''}>
                    <div class="card-icon">${action.layer === 'military' ? '🎖️' : action.layer === 'economy' ? '💰' : action.layer === 'intelligence' ? '🕵️' : action.layer === 'diplomacy' ? '🤝' : '⚙️'}</div>
                    <div class="card-title">${action.label}</div>
                    <div class="card-cost">${formatCosts(action.cost)}</div>
                </button>
            `).join('');
            
            document.getElementById('alertActions').innerHTML = actionsHtml;
        }

        // Override the original switchToLayer to include interactive controls
        const originalSwitchToLayer = switchToLayer;
        switchToLayer = function(layerName) {
            originalSwitchToLayer(layerName);
            // Open the clean panel instead of the old controls
            if (document.getElementById('layerControlsPanel').style.display === 'none') {
                toggleLayerControls();
            }
            switchLayerTab(layerName);
        };



        // Add CSS for enhanced notifications
        function addEnhancedNotificationStyles() {
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn { 
                    from { transform: translateX(100%); } 
                    to { transform: translateX(0); } 
                }
                @keyframes slideOut { 
                    from { transform: translateX(0); } 
                    to { transform: translateX(100%); } 
                }
                
                .enhanced-notification .notification-header {
                    display: flex; align-items: center; gap: 10px; margin-bottom: 10px;
                }
                
                .enhanced-notification .notification-icon { 
                    font-size: 24px; 
                }
                
                .enhanced-notification .notification-title { 
                    font-weight: 700; font-size: 16px; color: #5AC8FA; flex: 1; 
                }
                
                .enhanced-notification .notification-close { 
                    background: none; border: none; color: rgba(255, 255, 255, 0.6); 
                    font-size: 18px; cursor: pointer; padding: 0; 
                }
                
                .enhanced-notification .notification-description { 
                    color: rgba(255, 255, 255, 0.9); line-height: 1.4; margin-bottom: 10px; 
                }
                
                .enhanced-notification .notification-effects { 
                    background: rgba(90, 200, 250, 0.1); border-radius: 6px; padding: 10px; 
                }
                
                .enhanced-notification .effects-title { 
                    font-size: 12px; color: #5AC8FA; margin-bottom: 8px; font-weight: 600; 
                }
                
                .enhanced-notification .effect-item { 
                    font-size: 11px; margin-bottom: 4px; display: flex; gap: 8px; 
                }
                
                .enhanced-notification .effect-layer { 
                    color: #FFC107; font-weight: 600; min-width: 80px; 
                }
                
                .enhanced-notification .effect-description { 
                    color: rgba(255, 255, 255, 0.8); 
                }
            `;
            document.head.appendChild(style);
        }

        // Initialize comprehensive gameplay system with enhanced features
        function initializeEnhancedGame() {
            addEnhancedNotificationStyles();
            initializeGameplaySystem();
            initializeF35Squadron();
            
            showEnhancedNotification({
                title: 'COALITIONS COMMAND CENTER ONLINE',
                description: 'Strategic gameplay systems activated. Your decisions will shape global events.',
                icon: '🌍',
                effects: [
                    { layer: 'system', description: 'All strategic layers operational' },
                    { layer: 'command', description: 'Real-time decision making enabled' },
                    { layer: 'military', description: 'F-35 squadron deployed' }
                ]
            });
        }

        // Global Military Infrastructure System
        let f35Squadron = [];
        let squadronTarget = null;
        let squadronActive = false;
        let targetEntity = null;
        let baseEntity = null;
        let flightPathEntity = null;
        
        // Military Bases Database
        let militaryBases = [];
        let cities = [];
        let strategicZones = [];
        let activeBases = new Set();

        async function initializeF35Squadron() {
            try {
                // Initialize global military infrastructure
                initializeMilitaryInfrastructure();
                
                // Show loading notification
                showEnhancedNotification({
                    title: '🔄 LOADING F-35 MODELS',
                    description: 'Loading F-35 Lightning II from GLTF format...',
                    icon: '🔄',
                    effects: [{ layer: 'system', description: 'Model loading in progress' }]
                });
                
                // Load F-35 model with much larger scale and better visibility
                const f35Model = await Cesium.Model.fromGltfAsync({
                    url: './public/models/f-35a_lightning_ii/scene.gltf',
                    scale: 200.0, // Much larger scale
                    minimumPixelSize: 128, // Larger minimum size
                    maximumScale: 1000.0, // Allow much larger scaling
                    color: Cesium.Color.WHITE, // Make them white for visibility
                    colorBlendMode: Cesium.ColorBlendMode.REPLACE
                });

                // Create squadron of 4 F-35s with much better positioning
                await createF35Squadron(f35Model);
                
                                // Add visual indicators for each F-35
                addF35VisualIndicators();
                
                // Add squadron control button
                addSquadronControls();
                
                // Add base marker
                addBaseMarker();
                
                // Add backup F-35 button in center
                addBackupF35Button();
                
                // Add military infrastructure panel
                addMilitaryInfrastructurePanel();
                
                console.log('✅ F-35 Squadron initialized successfully');
                
                // Show big notification that F-35s are ready
                showEnhancedNotification({
                    title: '🛩️ F-35 SQUADRON READY',
                    description: '4 F-35 Lightning II aircraft loaded from GLTF format and ready for deployment',
                    icon: '🛩️',
                    effects: [
                        { layer: 'military', description: 'Air superiority capability available' },
                        { layer: 'system', description: 'Click DEPLOY to see them in action' }
                    ]
                });
                
            } catch (error) {
                console.error('❌ Failed to load F-35 squadron:', error);
                
                // Try fallback to GLB format
                try {
                    console.log('🔄 Trying GLB fallback...');
                    const f35ModelGLB = await Cesium.Model.fromGltfAsync({
                        url: './public/models/f-35a_lightning_ii.glb',
                        scale: 200.0,
                        minimumPixelSize: 128,
                        maximumScale: 1000.0,
                        color: Cesium.Color.WHITE,
                        colorBlendMode: Cesium.ColorBlendMode.REPLACE
                    });
                    
                    // Use GLB model instead
                    await createF35Squadron(f35ModelGLB);
                    
                } catch (fallbackError) {
                    console.error('❌ GLB fallback also failed:', fallbackError);
                    
                    // Final fallback: Create simple F-35 entities
                    console.log('🔄 Creating simple F-35 entities as fallback...');
                    createSimpleF35Squadron();
                    
                    showEnhancedNotification({
                        title: '⚠️ F-35 FALLBACK MODE',
                        description: 'Using simple F-35 entities (3D models unavailable)',
                        icon: '⚠️',
                        effects: [{ layer: 'military', description: 'Basic squadron available' }]
                    });
                }
            }
        }

        function addSquadronControls() {
            // Add squadron control panel
            const squadronPanel = document.createElement('div');
            squadronPanel.id = 'squadronPanel';
            squadronPanel.innerHTML = `
                <div class="squadron-header">
                    <span class="squadron-icon">🛩️</span>
                    <span class="squadron-title">F-35 SQUADRON</span>
                    <button class="squadron-btn" onclick="toggleSquadron()">DEPLOY</button>
                </div>
                <div class="squadron-status" id="squadronStatus">Standby - 4 Aircraft Ready</div>
                <div class="squadron-coords" id="squadronCoords">Base: 40.71°N, -74.01°W</div>
                <div class="squadron-target" id="squadronTarget">Target: None</div>
                <div class="squadron-controls">
                    <button class="squadron-cam-btn" onclick="followSquadron()">📷 FOLLOW</button>
                    <button class="squadron-cam-btn" onclick="satelliteZoom()">🛰️ SATELLITE</button>
                    <button class="squadron-cam-btn" onclick="viewTarget()">🎯 VIEW TARGET</button>
                </div>
                <div class="squadron-zoom-controls" id="zoomControls" style="display: none;">
                    <button class="zoom-btn" onclick="zoomIn()">🔍 ZOOM IN</button>
                    <button class="zoom-btn" onclick="zoomOut()">🔍 ZOOM OUT</button>
                    <button class="zoom-btn" onclick="resetZoom()">🎯 RESET</button>
                </div>
            `;
            squadronPanel.style.cssText = `
                position: fixed; top: 100px; right: 20px; z-index: 9999;
                background: rgba(0, 0, 0, 0.95); border: 3px solid #FF4444; border-radius: 12px;
                padding: 15px; min-width: 250px; backdrop-filter: blur(20px);
                color: white; font-family: 'Inter', sans-serif;
                box-shadow: 0 0 20px rgba(255, 68, 68, 0.5);
            `;
            
            document.body.appendChild(squadronPanel);
            
            // Add CSS for squadron panel
            const style = document.createElement('style');
            style.textContent = `
                .squadron-header {
                    display: flex; align-items: center; gap: 10px; margin-bottom: 10px;
                }
                .squadron-icon { font-size: 20px; }
                .squadron-title { font-weight: 700; color: #5AC8FA; flex: 1; }
                .squadron-btn {
                    background: rgba(255, 68, 68, 0.3); border: 2px solid #FF4444;
                    color: #FF4444; padding: 8px 16px; border-radius: 8px;
                    font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s ease;
                    text-transform: uppercase; letter-spacing: 1px;
                }
                .squadron-btn:hover { background: rgba(255, 68, 68, 0.6); transform: scale(1.05); }
                .squadron-btn.active { background: rgba(255, 68, 68, 0.2); border-color: #ff4444; color: #ff4444; }
                .squadron-status { font-size: 12px; color: rgba(255, 255, 255, 0.8); margin-bottom: 5px; }
                .squadron-coords, .squadron-target { 
                    font-size: 11px; color: rgba(255, 255, 255, 0.7); 
                    margin-bottom: 3px; font-family: 'Courier New', monospace;
                }
                .squadron-controls {
                    display: flex; gap: 5px; margin-top: 8px;
                }
                .squadron-cam-btn {
                    background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3);
                    color: white; padding: 3px 8px; border-radius: 4px;
                    font-size: 10px; cursor: pointer; transition: all 0.3s ease;
                }
                .squadron-cam-btn:hover { background: rgba(255, 255, 255, 0.2); }
                .squadron-zoom-controls {
                    display: flex; gap: 3px; margin-top: 5px; flex-wrap: wrap;
                }
                .zoom-btn {
                    background: rgba(255, 193, 7, 0.2); border: 1px solid rgba(255, 193, 7, 0.5);
                    color: #FFC107; padding: 2px 6px; border-radius: 3px;
                    font-size: 9px; cursor: pointer; transition: all 0.3s ease;
                }
                .zoom-btn:hover { background: rgba(255, 193, 7, 0.4); }
            `;
            document.head.appendChild(style);
        }

        window.toggleSquadron = function() {
            if (!squadronActive) {
                deploySquadron();
            } else {
                returnSquadron();
            }
        };

        function deploySquadron() {
            if (squadronActive) return;
            
            squadronActive = true;
            const btn = document.querySelector('.squadron-btn');
            if (btn) {
                btn.textContent = 'RETURN';
                btn.classList.add('active');
            }
            
            // Set target (random location for demo)
            const targetLon = -74.006 + (Math.random() - 0.5) * 20; // Random target within 20 degrees
            const targetLat = 40.7128 + (Math.random() - 0.5) * 20;
            squadronTarget = Cesium.Cartesian3.fromDegrees(targetLon, targetLat, 0);
            
            // Add target marker and flight path
            addTargetMarker(targetLon, targetLat);
            addFlightPath();
            
            // IMMEDIATELY FLY TO SQUADRON LOCATION
            flyToSquadron();
            
            // Start squadron movement
            animateSquadronToTarget();
            
            // Update status with coordinates
            const targetCoords = `${targetLat.toFixed(2)}°N, ${targetLon.toFixed(2)}°E`;
            const statusElement = document.getElementById('squadronStatus');
            const targetElement = document.getElementById('squadronTarget');
            if (statusElement) statusElement.textContent = `Deployed - En route to target`;
            if (targetElement) targetElement.textContent = `Target: ${targetCoords}`;
            
            showEnhancedNotification({
                title: 'F-35 SQUADRON DEPLOYED',
                description: `Squadron of 4 F-35s en route to target at ${targetCoords}`,
                icon: '🛩️',
                effects: [{ layer: 'military', description: 'Air superiority mission active' }]
            });
        }

        function flyToSquadron() {
            if (f35Squadron.length === 0) return;
            
            const leadPosition = f35Squadron[0].entity.position;
            const cartographic = Cesium.Cartographic.fromCartesian(leadPosition);
            const lon = Cesium.Math.toDegrees(cartographic.longitude);
            const lat = Cesium.Math.toDegrees(cartographic.latitude);
            
            // Fly to squadron at close range
            viewer.camera.flyTo({
                destination: Cesium.Cartesian3.fromDegrees(lon, lat, 25000), // 25km altitude
                orientation: {
                    heading: 0,
                    pitch: -0.5,
                    roll: 0
                },
                duration: 2.0
            });
        }



        function animateSquadronToTarget() {
            if (!squadronActive || !squadronTarget) return;
            
            const duration = 15000; // 15 seconds to target
            const startTime = Date.now();
            
            function updateSquadron() {
                if (!squadronActive) return;
                
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // Calculate formation positions
                f35Squadron.forEach((f35, index) => {
                    const formationOffset = index * 500;
                    const currentPos = Cesium.Cartesian3.lerp(
                        f35.position,
                        squadronTarget,
                        progress,
                        new Cesium.Cartesian3()
                    );
                    
                    // Add formation offset
                    const offsetPos = Cesium.Cartesian3.add(
                        currentPos,
                        new Cesium.Cartesian3(formationOffset, 0, 0),
                        new Cesium.Cartesian3()
                    );
                    
                    // Update position
                    f35.entity.position = offsetPos;
                    
                    // Calculate heading to target
                    const direction = Cesium.Cartesian3.subtract(
                        squadronTarget,
                        f35.position,
                        new Cesium.Cartesian3()
                    );
                    const heading = Math.atan2(direction.y, direction.x);
                    
                    // Update orientation (only for model primitives, not entities)
                    if (f35.entity.orientation !== undefined) {
                        f35.entity.orientation = Cesium.Transforms.headingPitchRollQuaternion(
                            offsetPos,
                            new Cesium.HeadingPitchRoll(heading, 0, 0)
                        );
                    }
                });
                
                // Update visual indicators
                updateF35Indicators();
                
                // Update squadron position display
                if (f35Squadron.length > 0) {
                    const leadPosition = f35Squadron[0].entity.position;
                    const cartographic = Cesium.Cartographic.fromCartesian(leadPosition);
                    const lon = Cesium.Math.toDegrees(cartographic.longitude);
                    const lat = Cesium.Math.toDegrees(cartographic.latitude);
                    const alt = Math.round(cartographic.height / 1000); // km
                    
                    document.getElementById('squadronCoords').textContent = 
                        `Position: ${lat.toFixed(2)}°N, ${lon.toFixed(2)}°E (${alt}km)`;
                }
                
                if (progress < 1) {
                    requestAnimationFrame(updateSquadron);
                } else {
                    // Reached target
                    document.getElementById('squadronStatus').textContent = `Target reached - Mission complete`;
                    setTimeout(() => {
                        if (squadronActive) {
                            returnSquadron();
                        }
                    }, 3000);
                }
            }
            
            updateSquadron();
        }

        function animateSquadronToBase() {
            const basePosition = Cesium.Cartesian3.fromDegrees(-74.006, 40.7128, 10000);
            const duration = 12000; // 12 seconds to return
            const startTime = Date.now();
            
            function updateReturn() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                f35Squadron.forEach((f35, index) => {
                    const formationOffset = index * 500;
                    const currentPos = Cesium.Cartesian3.lerp(
                        f35.position,
                        basePosition,
                        progress,
                        new Cesium.Cartesian3()
                    );
                    
                    // Add formation offset
                    const offsetPos = Cesium.Cartesian3.add(
                        currentPos,
                        new Cesium.Cartesian3(formationOffset, 0, 0),
                        new Cesium.Cartesian3()
                    );
                    
                    f35.entity.position = offsetPos;
                    
                    // Calculate heading to base
                    const direction = Cesium.Cartesian3.subtract(
                        basePosition,
                        f35.position,
                        new Cesium.Cartesian3()
                    );
                    const heading = Math.atan2(direction.y, direction.x);
                    
                    // Update orientation (only for model primitives, not entities)
                    if (f35.entity.orientation !== undefined) {
                        f35.entity.orientation = Cesium.Transforms.headingPitchRollQuaternion(
                            offsetPos,
                            new Cesium.HeadingPitchRoll(heading, 0, 0)
                        );
                    }
                });
                
                // Update visual indicators
                updateF35Indicators();
                
                // Update squadron position display
                if (f35Squadron.length > 0) {
                    const leadPosition = f35Squadron[0].entity.position;
                    const cartographic = Cesium.Cartographic.fromCartesian(leadPosition);
                    const lon = Cesium.Math.toDegrees(cartographic.longitude);
                    const lat = Cesium.Math.toDegrees(cartographic.latitude);
                    const alt = Math.round(cartographic.height / 1000); // km
                    
                    document.getElementById('squadronCoords').textContent = 
                        `Position: ${lat.toFixed(2)}°N, ${lon.toFixed(2)}°E (${alt}km)`;
                }
                
                if (progress < 1) {
                    requestAnimationFrame(updateReturn);
                } else {
                    // Returned to base
                    document.getElementById('squadronStatus').textContent = `Standby - 4 Aircraft Ready`;
                    document.getElementById('squadronCoords').textContent = `Base: 40.71°N, -74.01°W`;
                    
                    // Update military layer status
                    const airSuperiority = document.getElementById('airSuperiority');
                    if (airSuperiority) {
                        airSuperiority.textContent = 'F-35 Squadron Ready';
                        airSuperiority.style.color = '#5AC8FA';
                    }
                }
            }
            
            updateReturn();
        }

        // Visual markers and flight path functions
        function addBaseMarker() {
            const basePosition = Cesium.Cartesian3.fromDegrees(-74.006, 40.7128, 0);
            
            baseEntity = viewer.entities.add({
                position: basePosition,
                point: {
                    pixelSize: 15,
                    color: Cesium.Color.CYAN,
                    outlineColor: Cesium.Color.WHITE,
                    outlineWidth: 2,
                    heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
                },
                label: {
                    text: 'F-35 BASE',
                    font: '14pt sans-serif',
                    fillColor: Cesium.Color.CYAN,
                    outlineColor: Cesium.Color.BLACK,
                    outlineWidth: 2,
                    style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                    pixelOffset: new Cesium.Cartesian2(0, -30),
                    heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
                }
            });
        }

        function addTargetMarker(lon, lat) {
            const targetPosition = Cesium.Cartesian3.fromDegrees(lon, lat, 0);
            
            targetEntity = viewer.entities.add({
                position: targetPosition,
                point: {
                    pixelSize: 20,
                    color: Cesium.Color.RED,
                    outlineColor: Cesium.Color.YELLOW,
                    outlineWidth: 3,
                    heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
                },
                label: {
                    text: 'TARGET',
                    font: '14pt sans-serif',
                    fillColor: Cesium.Color.RED,
                    outlineColor: Cesium.Color.WHITE,
                    outlineWidth: 2,
                    style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                    pixelOffset: new Cesium.Cartesian2(0, -35),
                    heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
                }
            });
        }

        function removeTargetMarker() {
            if (targetEntity) {
                viewer.entities.remove(targetEntity);
                targetEntity = null;
            }
        }

        function addFlightPath() {
            const basePosition = Cesium.Cartesian3.fromDegrees(-74.006, 40.7128, 0);
            const targetPosition = squadronTarget;
            
            flightPathEntity = viewer.entities.add({
                polyline: {
                    positions: [basePosition, targetPosition],
                    width: 3,
                    material: new Cesium.PolylineDashMaterialProperty({
                        color: Cesium.Color.YELLOW
                    }),
                    clampToGround: true
                }
            });
        }

        function removeFlightPath() {
            if (flightPathEntity) {
                viewer.entities.remove(flightPathEntity);
                flightPathEntity = null;
            }
        }

        window.followSquadron = function() {
            if (f35Squadron.length === 0) return;
            
            const leadPosition = f35Squadron[0].entity.position;
            const cartographic = Cesium.Cartographic.fromCartesian(leadPosition);
            const lon = Cesium.Math.toDegrees(cartographic.longitude);
            const lat = Cesium.Math.toDegrees(cartographic.latitude);
            const alt = cartographic.height + 5000; // 5km above aircraft
            
            viewer.camera.flyTo({
                destination: Cesium.Cartesian3.fromDegrees(lon, lat, alt),
                orientation: {
                    heading: 0,
                    pitch: -0.5,
                    roll: 0
                },
                duration: 2.0
            });
        };

        window.viewTarget = function() {
            if (!squadronTarget) return;
            
            const cartographic = Cesium.Cartographic.fromCartesian(squadronTarget);
            const lon = Cesium.Math.toDegrees(cartographic.longitude);
            const lat = Cesium.Math.toDegrees(cartographic.latitude);
            
            viewer.camera.flyTo({
                destination: Cesium.Cartesian3.fromDegrees(lon, lat, 50000),
                orientation: {
                    heading: 0,
                    pitch: -1.0,
                    roll: 0
                },
                duration: 2.0
            });
        };

        window.satelliteZoom = function() {
            if (f35Squadron.length === 0) return;
            
            // Toggle satellite tracking
            if (satelliteTracking) {
                stopSatelliteTracking();
                // Hide zoom controls
                document.getElementById('zoomControls').style.display = 'none';
                showEnhancedNotification({
                    title: '🛰️ SATELLITE TRACKING DISABLED',
                    description: 'Satellite tracking stopped',
                    icon: '📡',
                    effects: [{ layer: 'intelligence', description: 'Surveillance ended' }]
                });
                return;
            }
            
            const leadPosition = f35Squadron[0].entity.position;
            const cartographic = Cesium.Cartographic.fromCartesian(leadPosition);
            const lon = Cesium.Math.toDegrees(cartographic.longitude);
            const lat = Cesium.Math.toDegrees(cartographic.latitude);
            
            // Reset altitude to default
            currentSatelliteAltitude = 150000;
            
            // Satellite-style view: high altitude, looking straight down
            viewer.camera.flyTo({
                destination: Cesium.Cartesian3.fromDegrees(lon, lat, currentSatelliteAltitude),
                orientation: {
                    heading: 0,
                    pitch: -1.57, // -90 degrees (straight down)
                    roll: 0
                },
                duration: 3.0
            });
            
            // Show zoom controls
            document.getElementById('zoomControls').style.display = 'flex';
            
            // Start continuous satellite tracking
            startSatelliteTracking();
            
            showEnhancedNotification({
                title: '🛰️ SATELLITE TRACKING ACTIVATED',
                description: 'Satellite view following F-35 squadron at 150km altitude',
                icon: '🛰️',
                effects: [{ layer: 'intelligence', description: 'High-altitude surveillance active' }]
            });
        };

        let satelliteTracking = false;
        let satelliteTrackingInterval = null;
        let currentSatelliteAltitude = 150000; // Starting altitude in meters
        let minSatelliteAltitude = 5000; // Minimum zoom (5km)
        let maxSatelliteAltitude = 500000; // Maximum zoom (500km)

        function startSatelliteTracking() {
            if (satelliteTracking) return;
            
            satelliteTracking = true;
            
            // Update status to show satellite tracking
            const altitudeKm = Math.round(currentSatelliteAltitude / 1000);
            document.getElementById('squadronStatus').textContent = `🛰️ Satellite tracking (${altitudeKm}km)`;
            
            satelliteTrackingInterval = setInterval(() => {
                if (!satelliteTracking || f35Squadron.length === 0) {
                    stopSatelliteTracking();
                    return;
                }
                
                const leadPosition = f35Squadron[0].entity.position;
                const cartographic = Cesium.Cartographic.fromCartesian(leadPosition);
                const lon = Cesium.Math.toDegrees(cartographic.longitude);
                const lat = Cesium.Math.toDegrees(cartographic.latitude);
                
                // Smoothly update camera position to follow squadron
                viewer.camera.setView({
                    destination: Cesium.Cartesian3.fromDegrees(lon, lat, currentSatelliteAltitude),
                    orientation: {
                        heading: 0,
                        pitch: -1.57, // Straight down view
                        roll: 0
                    }
                });
            }, 100); // Update every 100ms for smooth tracking
        }

        function stopSatelliteTracking() {
            satelliteTracking = false;
            if (satelliteTrackingInterval) {
                clearInterval(satelliteTrackingInterval);
                satelliteTrackingInterval = null;
            }
            
            // Hide zoom controls
            document.getElementById('zoomControls').style.display = 'none';
            
            // Reset status if squadron is still active
            if (squadronActive) {
                document.getElementById('squadronStatus').textContent = `Deployed - En route to target`;
            }
        }

        // Zoom functions
        window.zoomIn = function() {
            if (!satelliteTracking || f35Squadron.length === 0) return;
            
            currentSatelliteAltitude = Math.max(currentSatelliteAltitude * 0.7, minSatelliteAltitude);
            updateSatelliteView();
            
            const altitudeKm = Math.round(currentSatelliteAltitude / 1000);
            showEnhancedNotification({
                title: '🔍 ZOOMING IN',
                description: `Satellite altitude: ${altitudeKm}km`,
                icon: '🔍',
                effects: [{ layer: 'intelligence', description: 'Enhanced detail view' }]
            });
        };

        window.zoomOut = function() {
            if (!satelliteTracking || f35Squadron.length === 0) return;
            
            currentSatelliteAltitude = Math.min(currentSatelliteAltitude * 1.4, maxSatelliteAltitude);
            updateSatelliteView();
            
            const altitudeKm = Math.round(currentSatelliteAltitude / 1000);
            showEnhancedNotification({
                title: '🔍 ZOOMING OUT',
                description: `Satellite altitude: ${altitudeKm}km`,
                icon: '🔍',
                effects: [{ layer: 'intelligence', description: 'Wide area view' }]
            });
        };

        window.resetZoom = function() {
            if (!satelliteTracking || f35Squadron.length === 0) return;
            
            currentSatelliteAltitude = 150000; // Reset to 150km
            updateSatelliteView();
            
            showEnhancedNotification({
                title: '🎯 ZOOM RESET',
                description: 'Satellite altitude: 150km',
                icon: '🎯',
                effects: [{ layer: 'intelligence', description: 'Standard surveillance view' }]
            });
        };

        function updateSatelliteView() {
            if (!satelliteTracking || f35Squadron.length === 0) return;
            
            const leadPosition = f35Squadron[0].entity.position;
            const cartographic = Cesium.Cartographic.fromCartesian(leadPosition);
            const lon = Cesium.Math.toDegrees(cartographic.longitude);
            const lat = Cesium.Math.toDegrees(cartographic.latitude);
            
            viewer.camera.setView({
                destination: Cesium.Cartesian3.fromDegrees(lon, lat, currentSatelliteAltitude),
                orientation: {
                    heading: 0,
                    pitch: -1.57, // Straight down view
                    roll: 0
                }
            });
            
            // Update status with current altitude
            const altitudeKm = Math.round(currentSatelliteAltitude / 1000);
            document.getElementById('squadronStatus').textContent = `🛰️ Satellite tracking (${altitudeKm}km)`;
        }

        function addF35VisualIndicators() {
            f35Squadron.forEach((f35, index) => {
                // Add a bright red sphere above each F-35 for visibility
                const indicator = viewer.entities.add({
                    position: f35.entity.position,
                    point: {
                        pixelSize: 20,
                        color: Cesium.Color.RED,
                        outlineColor: Cesium.Color.YELLOW,
                        outlineWidth: 3,
                        heightReference: Cesium.HeightReference.NONE
                    },
                    label: {
                        text: `F-35 ${index + 1}`,
                        font: '12pt sans-serif',
                        fillColor: Cesium.Color.RED,
                        outlineColor: Cesium.Color.WHITE,
                        outlineWidth: 2,
                        style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                        pixelOffset: new Cesium.Cartesian2(0, -25),
                        heightReference: Cesium.HeightReference.NONE
                    }
                });
                
                // Store reference to indicator
                f35.indicator = indicator;
            });
        }

        function updateF35Indicators() {
            f35Squadron.forEach((f35) => {
                if (f35.indicator) {
                    f35.indicator.position = f35.entity.position;
                }
            });
        }

        // MASSIVE MILITARY INFRASTRUCTURE SYSTEM
        function initializeMilitaryInfrastructure() {
            // Major Military Bases
            militaryBases = [
                // US Bases
                { name: "NORAD", lat: 38.7470, lon: -104.8454, type: "command", country: "USA", size: "massive" },
                { name: "Pentagon", lat: 38.8719, lon: -77.0563, type: "command", country: "USA", size: "massive" },
                { name: "Area 51", lat: 37.2350, lon: -115.8111, type: "secret", country: "USA", size: "large" },
                { name: "Fort Hood", lat: 31.1349, lon: -97.7756, type: "army", country: "USA", size: "large" },
                { name: "Camp Pendleton", lat: 33.3014, lon: -117.3616, type: "marine", country: "USA", size: "large" },
                { name: "Nellis AFB", lat: 36.2369, lon: -115.0347, type: "airforce", country: "USA", size: "large" },
                { name: "Naval Base San Diego", lat: 32.6799, lon: -117.1417, type: "navy", country: "USA", size: "large" },
                { name: "Fort Bragg", lat: 35.1397, lon: -79.0060, type: "army", country: "USA", size: "large" },
                { name: "Joint Base Andrews", lat: 38.8106, lon: -76.8672, type: "airforce", country: "USA", size: "large" },
                { name: "Naval Station Norfolk", lat: 36.9464, lon: -76.3264, type: "navy", country: "USA", size: "massive" },
                
                // NATO Bases
                { name: "RAF Lakenheath", lat: 52.4083, lon: 0.5608, type: "airforce", country: "UK", size: "large" },
                { name: "Ramstein AB", lat: 49.4369, lon: 7.6000, type: "airforce", country: "Germany", size: "large" },
                { name: "Aviano AB", lat: 46.0319, lon: 12.5967, type: "airforce", country: "Italy", size: "medium" },
                { name: "Incirlik AB", lat: 37.0021, lon: 35.4259, type: "airforce", country: "Turkey", size: "large" },
                { name: "Sigonella NAS", lat: 37.4017, lon: 14.9224, type: "navy", country: "Italy", size: "medium" },
                
                // Pacific Bases
                { name: "Yokota AB", lat: 35.7485, lon: 139.3485, type: "airforce", country: "Japan", size: "large" },
                { name: "Kadena AB", lat: 26.3556, lon: 127.7676, type: "airforce", country: "Japan", size: "large" },
                { name: "Osan AB", lat: 37.0902, lon: 127.0297, type: "airforce", country: "South Korea", size: "large" },
                { name: "Guam Naval Base", lat: 13.4443, lon: 144.7937, type: "navy", country: "USA", size: "large" },
                { name: "Diego Garcia", lat: -7.3195, lon: 72.4229, type: "navy", country: "UK", size: "medium" },
                
                // Middle East Bases
                { name: "Al Udeid AB", lat: 25.1172, lon: 51.3144, type: "airforce", country: "Qatar", size: "large" },
                { name: "Al Dhafra AB", lat: 24.2489, lon: 54.5477, type: "airforce", country: "UAE", size: "medium" },
                { name: "Kuwait Naval Base", lat: 29.3759, lon: 47.9774, type: "navy", country: "Kuwait", size: "medium" },
                
                // Strategic Locations
                { name: "Thule AB", lat: 76.5311, lon: -68.7032, type: "airforce", country: "Greenland", size: "medium" },
                { name: "Ascension Island", lat: -7.9465, lon: -14.3559, type: "navy", country: "UK", size: "small" },
                { name: "Falklands Base", lat: -51.7963, lon: -58.4677, type: "navy", country: "UK", size: "medium" }
            ];

            // Major Cities
            cities = [
                // North America
                { name: "New York", lat: 40.7128, lon: -74.0060, country: "USA", population: "8.8M", strategic: true },
                { name: "Los Angeles", lat: 34.0522, lon: -118.2437, country: "USA", population: "4M", strategic: true },
                { name: "Washington DC", lat: 38.9072, lon: -77.0369, country: "USA", population: "689K", strategic: true },
                { name: "Chicago", lat: 41.8781, lon: -87.6298, country: "USA", population: "2.7M", strategic: true },
                { name: "Houston", lat: 29.7604, lon: -95.3698, country: "USA", population: "2.3M", strategic: true },
                { name: "Toronto", lat: 43.6532, lon: -79.3832, country: "Canada", population: "2.9M", strategic: true },
                { name: "Mexico City", lat: 19.4326, lon: -99.1332, country: "Mexico", population: "9.2M", strategic: true },
                
                // Europe
                { name: "London", lat: 51.5074, lon: -0.1278, country: "UK", population: "8.9M", strategic: true },
                { name: "Paris", lat: 48.8566, lon: 2.3522, country: "France", population: "2.1M", strategic: true },
                { name: "Berlin", lat: 52.5200, lon: 13.4050, country: "Germany", population: "3.7M", strategic: true },
                { name: "Rome", lat: 41.9028, lon: 12.4964, country: "Italy", population: "2.8M", strategic: true },
                { name: "Madrid", lat: 40.4168, lon: -3.7038, country: "Spain", population: "3.2M", strategic: true },
                { name: "Moscow", lat: 55.7558, lon: 37.6176, country: "Russia", population: "12.5M", strategic: true },
                { name: "Istanbul", lat: 41.0082, lon: 28.9784, country: "Turkey", population: "15.5M", strategic: true },
                
                // Asia
                { name: "Tokyo", lat: 35.6762, lon: 139.6503, country: "Japan", population: "13.9M", strategic: true },
                { name: "Beijing", lat: 39.9042, lon: 116.4074, country: "China", population: "21.5M", strategic: true },
                { name: "Seoul", lat: 37.5665, lon: 126.9780, country: "South Korea", population: "9.7M", strategic: true },
                { name: "Singapore", lat: 1.3521, lon: 103.8198, country: "Singapore", population: "5.7M", strategic: true },
                { name: "Hong Kong", lat: 22.3193, lon: 114.1694, country: "China", population: "7.4M", strategic: true },
                { name: "Mumbai", lat: 19.0760, lon: 72.8777, country: "India", population: "20.4M", strategic: true },
                { name: "Delhi", lat: 28.7041, lon: 77.1025, country: "India", population: "18.9M", strategic: true },
                
                // Middle East
                { name: "Tehran", lat: 35.6892, lon: 51.3890, country: "Iran", population: "9.1M", strategic: true },
                { name: "Baghdad", lat: 33.3152, lon: 44.3661, country: "Iraq", population: "7.2M", strategic: true },
                { name: "Riyadh", lat: 24.7136, lon: 46.6753, country: "Saudi Arabia", population: "7.6M", strategic: true },
                { name: "Dubai", lat: 25.2048, lon: 55.2708, country: "UAE", population: "3.3M", strategic: true },
                { name: "Tel Aviv", lat: 32.0853, lon: 34.7818, country: "Israel", population: "4.4M", strategic: true },
                
                // Africa
                { name: "Cairo", lat: 30.0444, lon: 31.2357, country: "Egypt", population: "9.5M", strategic: true },
                { name: "Lagos", lat: 6.5244, lon: 3.3792, country: "Nigeria", population: "14.9M", strategic: true },
                { name: "Johannesburg", lat: -26.2041, lon: 28.0473, country: "South Africa", population: "5.6M", strategic: true },
                { name: "Nairobi", lat: -1.2921, lon: 36.8219, country: "Kenya", population: "4.4M", strategic: true },
                
                // South America
                { name: "São Paulo", lat: -23.5505, lon: -46.6333, country: "Brazil", population: "12.3M", strategic: true },
                { name: "Rio de Janeiro", lat: -22.9068, lon: -43.1729, country: "Brazil", population: "6.7M", strategic: true },
                { name: "Buenos Aires", lat: -34.6118, lon: -58.3960, country: "Argentina", population: "3.1M", strategic: true },
                { name: "Lima", lat: -12.0464, lon: -77.0428, country: "Peru", population: "9.5M", strategic: true },
                
                // Oceania
                { name: "Sydney", lat: -33.8688, lon: 151.2093, country: "Australia", population: "5.3M", strategic: true },
                { name: "Melbourne", lat: -37.8136, lon: 144.9631, country: "Australia", population: "5.1M", strategic: true },
                { name: "Auckland", lat: -36.8485, lon: 174.7633, country: "New Zealand", population: "1.6M", strategic: true }
            ];

            // Strategic Zones
            strategicZones = [
                // Maritime Chokepoints
                { name: "Strait of Hormuz", lat: 26.5920, lon: 56.2461, type: "maritime", strategic: "critical" },
                { name: "Strait of Malacca", lat: 1.3521, lon: 103.8198, type: "maritime", strategic: "critical" },
                { name: "Suez Canal", lat: 30.5852, lon: 32.2654, type: "maritime", strategic: "critical" },
                { name: "Panama Canal", lat: 9.0820, lon: -79.4977, type: "maritime", strategic: "critical" },
                { name: "Bosphorus Strait", lat: 41.0082, lon: 28.9784, type: "maritime", strategic: "high" },
                { name: "Gibraltar Strait", lat: 36.1408, lon: -5.3536, type: "maritime", strategic: "high" },
                
                // Air Corridors
                { name: "North Atlantic Route", lat: 55.0, lon: -30.0, type: "air", strategic: "high" },
                { name: "Pacific Route", lat: 35.0, lon: -150.0, type: "air", strategic: "high" },
                { name: "Arctic Route", lat: 75.0, lon: -100.0, type: "air", strategic: "medium" },
                
                // Resource Zones
                { name: "Persian Gulf", lat: 26.0, lon: 52.0, type: "resource", strategic: "critical" },
                { name: "South China Sea", lat: 12.0, lon: 113.0, type: "resource", strategic: "critical" },
                { name: "Arctic Resources", lat: 70.0, lon: -100.0, type: "resource", strategic: "high" },
                { name: "Gulf of Guinea", lat: 0.0, lon: 5.0, type: "resource", strategic: "medium" },
                
                // Conflict Zones
                { name: "Eastern Ukraine", lat: 48.6208, lon: 37.5278, type: "conflict", strategic: "high" },
                { name: "South China Sea", lat: 12.0, lon: 113.0, type: "conflict", strategic: "critical" },
                { name: "Kashmir", lat: 34.0479, lon: 74.2179, type: "conflict", strategic: "high" },
                { name: "Gaza Strip", lat: 31.5017, lon: 34.4668, type: "conflict", strategic: "high" },
                { name: "Taiwan Strait", lat: 24.0, lon: 120.0, type: "conflict", strategic: "critical" },
                { name: "Korean DMZ", lat: 38.0, lon: 127.0, type: "conflict", strategic: "critical" }
            ];

            // Create all entities
            createMilitaryEntities();
        }

        function createMilitaryEntities() {
            // Create Military Bases
            militaryBases.forEach(base => {
                const color = getBaseColor(base.type);
                const size = getBaseSize(base.size);
                
                const entity = viewer.entities.add({
                    position: Cesium.Cartesian3.fromDegrees(base.lon, base.lat, 0),
                    point: {
                        pixelSize: size,
                        color: color,
                        outlineColor: Cesium.Color.WHITE,
                        outlineWidth: 2,
                        heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
                    },
                    label: {
                        text: base.name,
                        font: '12pt sans-serif',
                        fillColor: color,
                        outlineColor: Cesium.Color.BLACK,
                        outlineWidth: 2,
                        style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                        pixelOffset: new Cesium.Cartesian2(0, -size - 5),
                        heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
                    }
                });
                
                base.entity = entity;
            });

            // Create Cities
            cities.forEach(city => {
                const entity = viewer.entities.add({
                    position: Cesium.Cartesian3.fromDegrees(city.lon, city.lat, 0),
                    point: {
                        pixelSize: 8,
                        color: Cesium.Color.YELLOW,
                        outlineColor: Cesium.Color.ORANGE,
                        outlineWidth: 2,
                        heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
                    },
                    label: {
                        text: `${city.name} (${city.population})`,
                        font: '10pt sans-serif',
                        fillColor: Cesium.Color.YELLOW,
                        outlineColor: Cesium.Color.BLACK,
                        outlineWidth: 2,
                        style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                        pixelOffset: new Cesium.Cartesian2(0, -15),
                        heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
                    }
                });
                
                city.entity = entity;
            });

            // Create Strategic Zones
            strategicZones.forEach(zone => {
                const color = getZoneColor(zone.strategic);
                const size = getZoneSize(zone.strategic);
                
                const entity = viewer.entities.add({
                    position: Cesium.Cartesian3.fromDegrees(zone.lon, zone.lat, 0),
                    point: {
                        pixelSize: size,
                        color: color,
                        outlineColor: Cesium.Color.WHITE,
                        outlineWidth: 3,
                        heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
                    },
                    label: {
                        text: `${zone.name} (${zone.type})`,
                        font: '11pt sans-serif',
                        fillColor: color,
                        outlineColor: Cesium.Color.BLACK,
                        outlineWidth: 2,
                        style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                        pixelOffset: new Cesium.Cartesian2(0, -size - 5),
                        heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
                    }
                });
                
                zone.entity = entity;
            });

            console.log(`✅ Created ${militaryBases.length} military bases, ${cities.length} cities, and ${strategicZones.length} strategic zones`);
        }

        function getBaseColor(type) {
            const colors = {
                command: Cesium.Color.RED,
                secret: Cesium.Color.PURPLE,
                army: Cesium.Color.GREEN,
                marine: Cesium.Color.DARKGREEN,
                airforce: Cesium.Color.BLUE,
                navy: Cesium.Color.DARKBLUE
            };
            return colors[type] || Cesium.Color.GRAY;
        }

        function getBaseSize(size) {
            const sizes = {
                small: 12,
                medium: 16,
                large: 20,
                massive: 25
            };
            return sizes[size] || 16;
        }

        function getZoneColor(strategic) {
            const colors = {
                critical: Cesium.Color.RED,
                high: Cesium.Color.ORANGE,
                medium: Cesium.Color.YELLOW,
                low: Cesium.Color.GREEN
            };
            return colors[strategic] || Cesium.Color.GRAY;
        }

        function getZoneSize(strategic) {
            const sizes = {
                critical: 18,
                high: 14,
                medium: 10,
                low: 8
            };
            return sizes[strategic] || 12;
        }

        async function createF35Squadron(f35Model) {
            const squadronSize = 4;
            const basePosition = Cesium.Cartesian3.fromDegrees(-74.006, 40.7128, 15000); // Higher altitude
            
            for (let i = 0; i < squadronSize; i++) {
                const offset = i * 1000; // 1km spacing between aircraft for better visibility
                const position = Cesium.Cartesian3.fromDegrees(
                    -74.006 + (i * 0.02), // More spread out
                    40.7128 + (i * 0.01), // More spread out
                    15000 + offset
                );

                const f35 = viewer.scene.primitives.add(f35Model.clone());
                f35.position = position;
                f35.orientation = Cesium.Transforms.headingPitchRollQuaternion(position, new Cesium.HeadingPitchRoll(0, 0, 0));
                
                // Add to squadron array
                f35Squadron.push({
                    entity: f35,
                    position: position,
                    heading: 0,
                    speed: 0,
                    formationIndex: i
                });
            }
        }

        function createSimpleF35Squadron() {
            const squadronSize = 4;
            
            for (let i = 0; i < squadronSize; i++) {
                const offset = i * 1000; // 1km spacing between aircraft
                const position = Cesium.Cartesian3.fromDegrees(
                    -74.006 + (i * 0.02), // More spread out
                    40.7128 + (i * 0.01), // More spread out
                    15000 + offset
                );

                // Create simple F-35 entity with large red sphere
                const f35Entity = viewer.entities.add({
                    position: position,
                    point: {
                        pixelSize: 30,
                        color: Cesium.Color.RED,
                        outlineColor: Cesium.Color.WHITE,
                        outlineWidth: 3,
                        heightReference: Cesium.HeightReference.NONE
                    },
                    label: {
                        text: `F-35 ${i + 1}`,
                        font: '14pt sans-serif',
                        fillColor: Cesium.Color.RED,
                        outlineColor: Cesium.Color.WHITE,
                        outlineWidth: 2,
                        style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                        pixelOffset: new Cesium.Cartesian2(0, -40),
                        heightReference: Cesium.HeightReference.NONE
                    }
                });
                
                // Add to squadron array
                f35Squadron.push({
                    entity: f35Entity,
                    position: position,
                    heading: 0,
                    speed: 0,
                    formationIndex: i
                });
            }
        }

        function addBackupF35Button() {
            const backupButton = document.createElement('div');
            backupButton.id = 'backupF35Button';
            backupButton.innerHTML = `
                <div style="
                    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                    background: rgba(255, 68, 68, 0.9); border: 3px solid #FF4444;
                    color: white; padding: 20px; border-radius: 15px; z-index: 10000;
                    font-family: 'Inter', sans-serif; font-size: 18px; font-weight: bold;
                    text-align: center; cursor: pointer; box-shadow: 0 0 30px rgba(255, 68, 68, 0.8);
                    animation: pulse 2s infinite;
                ">
                    <div style="font-size: 40px; margin-bottom: 10px;">🛩️</div>
                    <div>F-35 SQUADRON</div>
                    <div style="font-size: 14px; margin-top: 5px;">CLICK TO DEPLOY</div>
                </div>
            `;
            
            // Add pulse animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes pulse {
                    0% { transform: translate(-50%, -50%) scale(1); }
                    50% { transform: translate(-50%, -50%) scale(1.05); }
                    100% { transform: translate(-50%, -50%) scale(1); }
                }
            `;
            document.head.appendChild(style);
            
            backupButton.onclick = function() {
                if (!squadronActive) {
                    deploySquadron();
                }
                // Hide backup button after first use
                backupButton.style.display = 'none';
            };
            
            document.body.appendChild(backupButton);
            
            // Hide backup button after 10 seconds
            setTimeout(() => {
                if (backupButton) {
                    backupButton.style.display = 'none';
                }
            }, 10000);
        }

        function addMilitaryInfrastructurePanel() {
            const panel = document.createElement('div');
            panel.id = 'militaryInfrastructurePanel';
            panel.innerHTML = `
                <div class="infrastructure-header">
                    <span class="infrastructure-icon">🌍</span>
                    <span class="infrastructure-title">GLOBAL MILITARY INFRASTRUCTURE</span>
                </div>
                <div class="infrastructure-stats">
                    <div class="stat-item">
                        <span class="stat-label">Military Bases:</span>
                        <span class="stat-value">${militaryBases.length}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Strategic Cities:</span>
                        <span class="stat-value">${cities.length}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Strategic Zones:</span>
                        <span class="stat-value">${strategicZones.length}</span>
                    </div>
                </div>
                <div class="infrastructure-controls">
                    <button class="infra-btn" onclick="toggleMilitaryBases()">🏛️ BASES</button>
                    <button class="infra-btn" onclick="toggleCities()">🏙️ CITIES</button>
                    <button class="infra-btn" onclick="toggleStrategicZones()">🎯 ZONES</button>
                    <button class="infra-btn" onclick="flyToRandomBase()">🎲 RANDOM BASE</button>
                </div>
            `;
            panel.style.cssText = `
                position: fixed; top: 200px; right: 20px; z-index: 9998;
                background: rgba(0, 0, 0, 0.95); border: 2px solid #00FF00; border-radius: 12px;
                padding: 15px; min-width: 280px; backdrop-filter: blur(20px);
                color: white; font-family: 'Inter', sans-serif;
            `;
            
            document.body.appendChild(panel);
            
            // Add CSS for infrastructure panel
            const style = document.createElement('style');
            style.textContent = `
                .infrastructure-header {
                    display: flex; align-items: center; gap: 10px; margin-bottom: 10px;
                }
                .infrastructure-icon { font-size: 20px; }
                .infrastructure-title { font-weight: 700; color: #00FF00; flex: 1; font-size: 12px; }
                .infrastructure-stats {
                    margin-bottom: 10px;
                }
                .stat-item {
                    display: flex; justify-content: space-between; margin-bottom: 3px;
                    font-size: 11px;
                }
                .stat-label { color: rgba(255, 255, 255, 0.8); }
                .stat-value { color: #00FF00; font-weight: bold; }
                .infrastructure-controls {
                    display: flex; gap: 5px; flex-wrap: wrap;
                }
                .infra-btn {
                    background: rgba(0, 255, 0, 0.2); border: 1px solid #00FF00;
                    color: #00FF00; padding: 4px 8px; border-radius: 4px;
                    font-size: 9px; cursor: pointer; transition: all 0.3s ease;
                }
                .infra-btn:hover { background: rgba(0, 255, 0, 0.4); }
            `;
            document.head.appendChild(style);
        }

        // Military Infrastructure Control Functions
        window.toggleMilitaryBases = function() {
            const visible = militaryBases[0]?.entity?.show !== false;
            militaryBases.forEach(base => {
                if (base.entity) {
                    base.entity.show = !visible;
                }
            });
            
            const btn = document.querySelector('.infra-btn');
            if (btn) btn.textContent = visible ? '🏛️ SHOW BASES' : '🏛️ HIDE BASES';
            
            showEnhancedNotification({
                title: visible ? '🏛️ MILITARY BASES HIDDEN' : '🏛️ MILITARY BASES VISIBLE',
                description: `${militaryBases.length} military bases ${visible ? 'hidden' : 'displayed'}`,
                icon: '🏛️',
                effects: [{ layer: 'military', description: 'Infrastructure visibility toggled' }]
            });
        };

        window.toggleCities = function() {
            const visible = cities[0]?.entity?.show !== false;
            cities.forEach(city => {
                if (city.entity) {
                    city.entity.show = !visible;
                }
            });
            
            const btn = document.querySelector('.infra-btn:nth-child(2)');
            if (btn) btn.textContent = visible ? '🏙️ SHOW CITIES' : '🏙️ HIDE CITIES';
            
            showEnhancedNotification({
                title: visible ? '🏙️ CITIES HIDDEN' : '🏙️ CITIES VISIBLE',
                description: `${cities.length} strategic cities ${visible ? 'hidden' : 'displayed'}`,
                icon: '🏙️',
                effects: [{ layer: 'intelligence', description: 'Urban centers visibility toggled' }]
            });
        };

        window.toggleStrategicZones = function() {
            const visible = strategicZones[0]?.entity?.show !== false;
            strategicZones.forEach(zone => {
                if (zone.entity) {
                    zone.entity.show = !visible;
                }
            });
            
            const btn = document.querySelector('.infra-btn:nth-child(3)');
            if (btn) btn.textContent = visible ? '🎯 SHOW ZONES' : '🎯 HIDE ZONES';
            
            showEnhancedNotification({
                title: visible ? '🎯 STRATEGIC ZONES HIDDEN' : '🎯 STRATEGIC ZONES VISIBLE',
                description: `${strategicZones.length} strategic zones ${visible ? 'hidden' : 'displayed'}`,
                icon: '🎯',
                effects: [{ layer: 'intelligence', description: 'Strategic areas visibility toggled' }]
            });
        };

        window.flyToRandomBase = function() {
            if (militaryBases.length === 0) return;
            
            const randomBase = militaryBases[Math.floor(Math.random() * militaryBases.length)];
            
            viewer.camera.flyTo({
                destination: Cesium.Cartesian3.fromDegrees(randomBase.lon, randomBase.lat, 100000),
                orientation: {
                    heading: 0,
                    pitch: -0.5,
                    roll: 0
                },
                duration: 3.0
            });
            
            showEnhancedNotification({
                title: '🎲 FLYING TO RANDOM BASE',
                description: `Flying to ${randomBase.name} (${randomBase.country})`,
                icon: '🎲',
                effects: [{ layer: 'military', description: 'Strategic location accessed' }]
            });
        };

        // Stop satellite tracking when squadron returns
        function returnSquadron() {
            if (!squadronActive) return;
            
            squadronActive = false;
            const btn = document.querySelector('.squadron-btn');
            if (btn) {
                btn.textContent = 'DEPLOY';
                btn.classList.remove('active');
            }
            
            // Stop satellite tracking
            stopSatelliteTracking();
            
            // Remove target marker and flight path
            removeTargetMarker();
            removeFlightPath();
            
            // Return to base
            animateSquadronToBase();
            
            // Update status
            const statusElement = document.getElementById('squadronStatus');
            const targetElement = document.getElementById('squadronTarget');
            if (statusElement) statusElement.textContent = `Returning to base - 4 Aircraft`;
            if (targetElement) targetElement.textContent = `Target: None`;
            
            showEnhancedNotification({
                title: 'F-35 SQUADRON RETURNING',
                description: 'Squadron returning to base after mission',
                icon: '🛩️',
                effects: [{ layer: 'military', description: 'Mission completed' }]
            });
        }

        // Override the final initialization to include gameplay systems
        const originalUpdateLoading = updateLoading;
        updateLoading = function() {
            if (originalUpdateLoading) {
                originalUpdateLoading();
            }
            
            // After a short delay, initialize the enhanced game
            setTimeout(initializeEnhancedGame, 2000);
        };
    </script>
</body>
</html>